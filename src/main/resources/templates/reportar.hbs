{{#partial "nav_izquierda"}}
    <a href="javascript:history.back()"
       class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
       title="Volver al panel">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="d-none d-sm-block">Volver</span>
    </a>
{{/partial}}

{{#partial "contenido"}}
    <div class="d-flex flex-column">
        <div class="d-flex flex-column cabecera shadow bg-white rounded p-3">
            <h3 style="font-weight: 600;">Hecho: {{hecho.titulo}}</h3>
            <div class="d-flex flex-column detalles">
                <div class="d-flex flex-column">
                    <h5 style="font-weight: 600;">Motivo del reporte</h5>

                    <div id="mensajeEstado"></div>

                    <label for="motivoInput" class="form-label"></label>
                    <textarea
                            class="form-control"
                            id="motivoInput"
                            rows="4"
                            placeholder="Escriba su motivo aquí."></textarea>
                    <h6 style="margin-top: 1vh;">El reporte debe tener un mínimo de 500 carácteres explicando sus razones para eliminar el hecho,
                        no se aceptan insultos ni vaguedades. Una vez enviado el reporte, este no se puede deshacer y
                        será almacenado para su consecuente análisis durante los siguientes 7 días posteriores al
                        lanzamiento del mismo. La empresa no se hace responsable ante cualquier inconveniente.
                    </h6>
                    <div class="d-flex flex-row" style="justify-content: end; margin-top: 3vh; gap: 3vh;">
                        <button type="button" class="btn btn-secondary" onclick="vaciarMotivo()">Restablecer</button>
                        <button type="button" class="btn btn-primary" onclick="enviarSolicitud({{hecho.id}})">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function vaciarMotivo() {
            document.getElementById('motivoInput').value = "";
            mostrarMensaje("info", "El motivo fue restablecido.");
        }

        function enviarSolicitud(hechoId) {
            const motivo = document.getElementById('motivoInput').value.trim();

            if (motivo.length < 500) {
                mostrarMensaje("danger", "El motivo debe tener al menos 500 caracteres.");
                return;
            }

            if (motivo.length > 1024) {
                mostrarMensaje("danger", "El motivo debe tener menos de 1024 caracteres.");
                return;
            }

            const solicitud = {
                motivo_solicitud: motivo,
                hecho_solicitado: hechoId
            };

            fetch("/solicitudes", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(solicitud)
            })
                    .then(async resp => {
                        if (resp.ok) {
                            mostrarMensaje("success", "Solicitud enviada correctamente. Redirigiendo...");
                            setTimeout(() => window.location.href = "/", 1500);
                        } else {
                            const error = await resp.text();
                            mostrarMensaje("danger", "Error al enviar la solicitud: " + error);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        mostrarMensaje("danger", "Ocurrió un error inesperado.");
                    });
        }

        function mostrarMensaje(tipo, texto) {
            const contenedor = document.getElementById("mensajeEstado");

            contenedor.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${texto}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        }
    </script>
{{/partial}}

{{> templates/layout}}