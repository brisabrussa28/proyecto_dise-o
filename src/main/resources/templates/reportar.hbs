{{#partial "nav_izquierda"}}
    <button class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
            onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">Volver</span>
    </button>
{{/partial}}

{{#partial "contenido"}}
    <div class="d-flex flex-column">
        <div class="d-flex flex-column cabecera shadow bg-white rounded p-3">
            <a href="/hechos/{{hecho.id}}" class="text-decoration-none text-black">
                <h3 style="font-weight: 600;">
                    Hecho:
                    {{#if (gt hecho.titulo.length 80)}}
                        {{substring hecho.titulo 0 80}}...
                    {{else}}
                        {{hecho.titulo}}
                    {{/if}}
                </h3>
            </a>
            <div class="d-flex flex-column detalles">

                <div class="d-flex justify-content-between align-items-end mb-2">
                    <label for="motivoInput" class="h5 mb-0 fw-bold">Motivo del reporte</label>

                    <button type="button" class="btn btn-sm btn-outline-secondary"
                            onclick="vaciarMotivo()">
                        Restablecer
                    </button>
                </div>

                <div class="d-flex flex-column">
                    <div id="mensajeEstado"></div>

                    <textarea
                            class="form-control"
                            id="motivoInput"
                            rows="4"
                            maxlength="1024"
                            placeholder="Escriba su motivo aquí (mínimo 500 caracteres)..."
                            style="height: 350px"
                    ></textarea>

                    <div class="d-flex justify-content-end mt-1">
                        <small id="contadorCaracteres" class="text-muted fw-bold"
                               style="font-size: 0.85rem;">
                            0 / 1024
                        </small>
                    </div>

                    <h6 class="mt-3 text-muted small">
                        El reporte debe tener un mínimo de 500 carácteres explicando sus razones
                        para eliminar el hecho,
                        no se aceptan insultos ni vaguedades. Una vez enviado el reporte, este no se
                        puede deshacer y
                        será almacenado para su consecuente análisis durante los siguientes 7 días
                        posteriores al
                        lanzamiento del mismo. La empresa no se hace cargo de los datos filtrados en
                        la descripción.
                    </h6>

                    <div class="d-flex justify-content-end mt-3 gap-3">

                        <a href="javascript:history.back()"
                           class="btn btn-outline-secondary btn-lg">
                            Cancelar
                        </a>

                        <button type="button"
                                class="btn btn-danger btn-lg text-white"
                                id="btnAbrirModal">
                            Enviar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Reportar hecho-->
    <div class="modal fade" id="modalReportar" tabindex="-1" aria-labelledby="modalReportarLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title" id="modalReportarLabel">
                        <i class="fa-solid me-2"></i>Confirmar reporte
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-3">
                        <i class="fa-solid fa-triangle-exclamation fa-3x text-danger mb-3"></i>
                        <h6 class="fw-bold">¿Está seguro que desea reportar este hecho?</h6>
                    </div>

                    <div class="alert alert-warning border-0 d-flex align-items-start small">
                        <i class="fa-solid fa-info-circle mt-1 me-2"></i>
                        <div>
                            <div class="mt-2 text-muted">
                                Esta acción no se puede deshacer.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary btn-lg"
                            data-bs-dismiss="modal">
                        <i class="fa-solid fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button"
                            class="btn btn-danger btn-lg text-white"
                            onclick="enviarSolicitud()">
                        Enviar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal-content {
            border-radius: 12px;
            overflow: hidden;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
        }
    </style>

    <!-- Modal de Éxito -->
    <div class="modal fade" id="modalExitoReporte" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-circle-check me-2"></i>Reporte enviado
                    </h5>
                </div>
                <div class="modal-body text-center p-4">
                    <p class="fw-bold mb-3">El reporte fue enviado correctamente.</p>
                    <div class="d-flex justify-content-center mt-3" role="status" aria-live="polite"
                         aria-busy="true">
                        <div class="spinner-border text-success" role="status"
                             aria-hidden="true"></div>
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function vaciarMotivo() {
            document.getElementById('motivoInput').value = "";
        }

        const MIN_CHARS = 500;
        const MAX_CHARS = 1024;

        const motivoInput = document.getElementById('motivoInput');
        const contador = document.getElementById('contadorCaracteres');
        const btnEnviar = document.querySelector('button[onclick="enviarSolicitud()"]');

        motivoInput.addEventListener('input', function () {
            const largoActual = this.value.length;

            contador.textContent = `${largoActual} / ${MAX_CHARS}`;

            if (largoActual < MIN_CHARS) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                contador.classList.add('text-danger');
                contador.classList.remove('text-success', 'text-muted');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                contador.classList.remove('text-danger', 'text-muted');
                contador.classList.add('text-success');
            }
        });

        // Validar también al enviar
        function enviarSolicitud() {
            const motivo = motivoInput.value.trim();
            const hechoId = {{hecho.id}};

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalReportar'));
            modal.hide();

            // Validación estricta
            if (!motivo || motivo.length < MIN_CHARS) {
                mostrarMensaje("danger", `El motivo debe tener al menos ${MIN_CHARS} caracteres.`);
                motivoInput.classList.add('is-invalid');
                motivoInput.focus();
                return;
            }

            const solicitud = {
                motivo_solicitud: motivo,
                hecho_solicitado: hechoId
            };

            // Deshabilitar botón para evitar doble click
            if (btnEnviar) btnEnviar.disabled = true;

            fetch("/solicitudes", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(solicitud)
            })
                    .then(async resp => {
                        if (resp.ok) {
                            // Mostrar modal de éxito
                            const modalExito = new bootstrap.Modal(document.getElementById("modalExitoReporte"));
                            modalExito.show();

                            // Redirigir después de 1.5 segundos
                            setTimeout(() => window.location.href = "/", 1500);
                        } else {
                            const error = await resp.text();
                            mostrarMensaje("danger", "Error al enviar la solicitud: " + error);
                            if (btnEnviar) btnEnviar.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        mostrarMensaje("danger", "Ocurrió un error inesperado.");
                        if (btnEnviar) btnEnviar.disabled = false;
                    });
        }

        function mostrarMensaje(tipo, texto) {
            const contenedor = document.getElementById("mensajeEstado");
            contenedor.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${texto}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        const btnAbrirModal = document.getElementById("btnAbrirModal");

        btnAbrirModal.addEventListener("click", function () {
            const motivo = motivoInput.value.trim();

            if (motivo.length < MIN_CHARS) {
                mostrarMensaje("danger", `El motivo debe tener al menos ${MIN_CHARS} caracteres.`);
                motivoInput.classList.add('is-invalid');
                motivoInput.focus();
                return;
            }

            // Abrir modal manualmente
            const modal = new bootstrap.Modal(document.getElementById('modalReportar'));
            modal.show();
        });
    </script>
{{/partial}}

{{> templates/layout}}