{{#partial "nav_izquierda"}}
    <button class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
            onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">Volver</span>
    </button>
{{/partial}}

{{#partial "contenido"}}
    <div class="container-sm py-4 mx-auto">
        <div class="bg-white bg-opacity-75 p-3 rounded shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 border-secondary border-opacity-25">
                <h2 class="fw-bold">
                    <i class="fa-solid fa-map-location-dot me-2"></i>
                    Hechos Registrados
                </h2>
            </div>

            <form id="searchForm" class="mb-3 p-3 bg-light rounded border">
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label for="searchInput" class="form-label fw-bold">Título</label>
                        <input id="searchInput" type="text" class="form-control"
                               placeholder="Buscar hechos por título..."
                               name="titulo" value="{{query}}">
                    </div>
                    <div class="col-md-3">
                        <label for="categoriaSelect" class="form-label fw-bold">Categoría</label>
                        <select class="form-select" id="categoriaSelect" name="categoria">
                            <option value="0">Todas las categorías</option>
                            {{#each categorias}}
                                <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check pt-4">
                            <input class="form-check-input" type="checkbox"
                                   id="soloConsensuados" name="consensuados"
                                   {{#if soloConsensuados}}checked{{/if}}>
                            <label class="form-check-label user-select-none" for="soloConsensuados">
                                Solo consensuados
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100 fw-bold" type="submit">
                            <i class="fa-solid fa-search me-1"></i> Buscar
                        </button>
                    </div>
                </div>
            </form>

            <div class="list-group" id="resultsList">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Cargando hechos...</p>
                </div>
            </div>

            <nav class="mt-4">
                <ul class="pagination pagination-sm justify-content-center"
                    id="paginationContainer"
                    style="display: none;">
                </ul>
            </nav>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function truncateText(text, maxLength = 100) {
                if (!text) return '';
                text = text.toString();
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const categoriaSelect = document.getElementById('categoriaSelect');
            const soloConsensuados = document.getElementById('soloConsensuados');
            const resultsList = document.getElementById('resultsList');
            const paginationContainer = document.getElementById('paginationContainer');

            async function cargarCategorias() {
                try {
                    const res = await fetch('/hechos/categorias');

                    if (res.ok) {
                        const categorias = await res.json();
                        const urlParams = new URLSearchParams(window.location.search);
                        const catSeleccionada = urlParams.get('categoria') || '0';

                        while (categoriaSelect.options.length > 1) {
                            categoriaSelect.remove(1);
                        }

                        categorias.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = truncateText(cat, 100);
                            if (cat === catSeleccionada) option.selected = true;
                            categoriaSelect.appendChild(option);
                        });
                    }
                } catch (e) {
                    console.error("Error cargando categorías:", e);
                }
            }

            if (categoriaSelect.options.length <= 1) {
                cargarCategorias();
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                const catSeleccionada = urlParams.get('categoria') || '0';
                if (catSeleccionada !== '0') {
                    categoriaSelect.value = catSeleccionada;
                }
            }

            function formatDate(dateInput) {
                if (!dateInput) return 'Fecha no disponible';
                let date;

                if (Array.isArray(dateInput)) {
                    date = new Date(dateInput[0], dateInput[1] - 1, dateInput[2], dateInput[3] || 0, dateInput[4] || 0);
                } else if (typeof dateInput === 'string' && dateInput.trim().startsWith('[')) {
                    try {
                        const parts = JSON.parse(dateInput);
                        if (Array.isArray(parts)) {
                            date = new Date(parts[0], parts[1] - 1, parts[2], parts[3] || 0, parts[4] || 0);
                        }
                    } catch (e) {
                    }
                }

                if (!date) {
                    date = new Date(dateInput);
                }

                if (isNaN(date.getTime())) return 'Fecha inválida';

                return date.toLocaleString('es-AR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }

            async function buscarHechos(titulo, categoria, consensuados = false, page = 1) {
                resultsList.innerHTML = '<div class="text-center py-5"><div ' +
                        'class="spinner-border text-primary" ' +
                        'role="status"></div><p ' +
                        'class="mt-2 text-muted">Buscando...</p></div>';
                paginationContainer.style.display = 'none';

                try {
                    const params = new URLSearchParams();
                    if (titulo) params.append('titulo', titulo);
                    if (categoria && categoria !== "0") params.append('categoria', categoria);
                    if (consensuados) params.append('soloConsensuados', 'true');
                    if ({{esAdmin}}) params.append('incluirEliminados', 'true');
                    params.append('page', page);
                    params.append('pageSize', 15);
                    params.append('paginar', 'true');
                    params.append('_t', Date.now());

                    const url = `/api/hechos/buscar-completo?${params.toString()}`;
                    const resp = await fetch(url);

                    if (!resp.ok) {
                        throw new Error(`Error del servidor (${resp.status})`);
                    }

                    const data = await resp.json();
                    let hechosResultantes = data.resultados || [];
                    const total = data.total || 0;
                    const paginaActual = data.paginaActual || 1;
                    const totalPaginas = data.totalPaginas || 1;

                    resultsList.innerHTML = '';

                    hechosResultantes.sort((a, b) => {
                        const aCols = a.colecciones || a.hecho_colecciones || [];
                        const bCols = b.colecciones || b.hecho_colecciones || [];
                        const aEsConsensuado = Array.isArray(aCols) && aCols.length > 0;
                        const bEsConsensuado = Array.isArray(bCols) && bCols.length > 0;

                        if (aEsConsensuado && !bEsConsensuado) return -1;
                        if (!aEsConsensuado && bEsConsensuado) return 1;
                        return 0;
                    });

                    if (hechosResultantes.length === 0) {
                        resultsList.innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                No se encontraron hechos con los criterios seleccionados.
                            </div>
                        `;
                        actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados);
                        return;
                    }

                    hechosResultantes.forEach(hecho => {
                        const titulo = truncateText(hecho.titulo || hecho.hecho_titulo || 'Sin título', 100);
                        const descripcion = truncateText(hecho.descripcion || hecho.hecho_descripcion || 'Sin descripción', 100);
                        const categoria = truncateText(hecho.categoria || hecho.hecho_categoria || 'General', 100);
                        const id = hecho.id || hecho.hecho_id;
                        const provincia = hecho.provincia || hecho.hecho_provincia || '';
                        const direccion = hecho.direccion || hecho.hecho_direccion || '';
                        const fechaRaw = hecho.fechaSuceso || hecho.hecho_fecha_suceso;
                        const fechaFormateada = formatDate(fechaRaw);
                        const colecciones = hecho.colecciones || hecho.hecho_colecciones || [];
                        const esConsensuado = Array.isArray(colecciones) && colecciones.length > 0;
                        const etiquetas = hecho.etiquetas || hecho.hecho_etiquetas || [];
                        const estado = (hecho.estado ?? hecho.hecho_estado ?? '').toString().trim().toUpperCase();
                        const eliminado = estado === 'ELIMINADO';
                        let etiquetasHTML = '';
                        if (Array.isArray(etiquetas)) {
                            etiquetasHTML = etiquetas.map(e => {
                                const nombre = e.nombre || e;
                                return `<span class="badge bg-secondary me-1">${nombre ? nombre.toString().replace(/,\s*/g, " ") : ''}</span>`;
                            }).join('');
                        }

                        const itemHTML = `
                            <a href="/hechos/${id}" class="list-group-item list-group-item-action py-3 border-start-0 border-end-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <h6 class="fw-bold text-dark mb-0 me-2">${titulo}</h6>
                                            ${esConsensuado ? '<span class="badge bg-success" title="Consensuado"><i class="fa-solid fa-check"></i></span>' : ''}
                                            ${eliminado ? '<span class="badge bg-danger">ELIMINADO</span>' : ''}
                                        </div>
                                        <p class="mb-2 text-muted small">${descripcion}</p>
                                        <div class="mb-2">
                                            <span class="badge bg-info text-dark me-1">${categoria}</span>
                                            ${etiquetasHTML}
                                        </div>
                                        <div class="small text-muted">
                                            <i class="fa-regular fa-calendar me-1"></i> ${fechaFormateada}
                                            <br>
                                            <i class="fa-solid fa-location-dot me-1"></i>
                                             ${provincia ? provincia + ' — ' : ''} ${direccion}
                                        </div>
                                    </div>
                                    <div class="ms-3 align-self-center">
                                        <i class="fa-solid fa-chevron-right text-muted"></i>
                                    </div>
                                </div>
                            </a>
                        `;
                        resultsList.insertAdjacentHTML('beforeend', itemHTML);
                    });

                    actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados);

                } catch (error) {
                    console.error(error);
                    resultsList.innerHTML = `<div class="alert alert-danger text-center">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i> Error al buscar: ${error.message}
                    </div>`;
                }
            }

            function actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados) {
                paginationContainer.innerHTML = '';
                if (totalPaginas <= 1) {
                    paginationContainer.style.display = 'none';
                    return;
                }
                paginationContainer.style.display = 'flex';

                const createPageItem = (page, text, isActive = false) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${isActive ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${page}">${text}</a>`;
                    return li;
                };

                if (paginaActual > 1) paginationContainer.appendChild(createPageItem(paginaActual - 1, 'Anterior'));

                const start = Math.max(1, paginaActual - 2);
                const end = Math.min(totalPaginas, paginaActual + 2);

                for (let i = start; i <= end; i++) {
                    paginationContainer.appendChild(createPageItem(i, i, i === paginaActual));
                }

                if (paginaActual < totalPaginas) paginationContainer.appendChild(createPageItem(paginaActual + 1, 'Siguiente'));

                paginationContainer.querySelectorAll('.page-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.target.getAttribute('data-page'));
                        buscarHechos(titulo, categoria, consensuados, page);
                        window.scrollTo({top: 0, behavior: 'smooth'});
                    });
                });
            }

            function ejecutarFiltros(e) {
                if (e && e.type === 'submit') {
                    e.preventDefault();
                }

                const titulo = searchInput.value.trim();
                const categoria = categoriaSelect.value;
                const consensuados = soloConsensuados.checked;

                const urlParams = new URLSearchParams(window.location.search);
                if (titulo) urlParams.set('titulo', titulo); else urlParams.delete('titulo');
                if (categoria !== '0') urlParams.set('categoria', categoria); else urlParams.delete('categoria');
                if (consensuados) urlParams.set('soloConsensuados', 'true'); else urlParams.delete('soloConsensuados');
                urlParams.delete('page');

                history.replaceState(null, '', `${window.location.pathname}?${urlParams.toString()}`);

                buscarHechos(titulo, categoria, consensuados);
            }

            searchForm.addEventListener('submit', ejecutarFiltros);

            const urlParams = new URLSearchParams(window.location.search);
            const tituloInicial = urlParams.get('titulo') || '';
            const categoriaInicial = urlParams.get('categoria') || '0';
            const consensuadosInicial = urlParams.get('soloConsensuados') === 'true';
            const pageInicial = parseInt(urlParams.get('page')) || 1;

            searchInput.value = tituloInicial;
            categoriaSelect.value = categoriaInicial;
            soloConsensuados.checked = consensuadosInicial;

            buscarHechos(tituloInicial, categoriaInicial, consensuadosInicial, pageInicial);
        });
    </script>
{{/partial}}

{{> templates/layout}}