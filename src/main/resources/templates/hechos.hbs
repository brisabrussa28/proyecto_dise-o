{{#partial "nav_izquierda"}}
    <a href="/admin/dashboard" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
       title="Volver al panel">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="d-none d-sm-block">Volver</span>
    </a>
{{/partial}}

{{#partial "contenido"}}
    <div class="container-sm py-4 mx-auto">
        <div class="bg-white bg-opacity-75 p-3 rounded">
            <h2 class="fw-bold mb-3 text-center">
                <i class="fa-solid fa-map-location-dot me-2"></i>
                Hechos registrados
            </h2>

            <form id="searchForm" class="mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label for="searchInput" class="form-label">Título</label>
                        <input id="searchInput" type="text" class="form-control"
                               placeholder="Buscar hechos por título..."
                               name="titulo" value="{{query}}">
                    </div>
                    <div class="col-md-3">
                        <label for="categoriaSelect" class="form-label">Categoría</label>
                        <select class="form-select" id="categoriaSelect" name="categoria">
                            <option value="0">Todas las categorías</option>
                            {{#each categorias}}
                                <option value="{{this}}" {{#if (eq this ../categoriaSeleccionada)}}selected{{/if}}>{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check pt-3">
                            <input class="form-check-input" type="checkbox"
                                   id="soloConsensuados" name="consensuados"
                                   {{#if soloConsensuados}}checked{{/if}}>
                            <label class="form-check-label" for="soloConsensuados">
                                Solo consensuados
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="fa-solid fa-search me-1"></i> Buscar
                        </button>
                    </div>
                </div>
            </form>

            <div class="list-group" id="resultsList">
                {{#each hechos}}
                    <a href="/hechos/{{id}}" class="list-group-item list-group-item-action py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold text-dark mb-1">{{hecho_titulo}}</h6>
                                <p class="mb-2 text-muted small">{{hecho_descripcion}}</p>
                                <div class="mb-2">
                                    <span class="badge bg-info text-dark">{{hecho_categoria}}</span>
                                    {{#if etiquetas}}
                                        {{#each etiquetas}}
                                            <span class="badge bg-secondary">{{nombre}}</span>
                                        {{/each}}
                                    {{/if}}
                                </div>
                                <div class="small text-muted">
                                    <i class="fa-regular fa-calendar me-1"></i>
                                    {{#if hecho_fecha_suceso}}
                                        {{formatDate hecho_fecha_suceso "dd/MM/yyyy HH:mm"}}
                                    {{else}}
                                        Fecha no disponible
                                    {{/if}}
                                    <br>
                                    <i class="fa-solid fa-location-dot me-1"></i>
                                    {{#if hecho_provincia}}
                                        {{hecho_provincia}} —
                                    {{/if}}
                                    {{hecho_direccion}}
                                </div>
                            </div>
                            {{#if colecciones}}
                                <span class="badge bg-success ms-2 align-self-start" title="Hecho consensuado">✓</span>
                            {{/if}}
                        </div>
                    </a>
                {{/each}}
            </div>

            <nav class="mt-3">
                <ul class="pagination pagination-sm justify-content-center" id="paginationContainer">
                    {{#if (gt paginaActual 1)}}
                        <li class="page-item">
                            <a class="page-link" href="/api/hechos?page={{subtract paginaActual 1}}">Anterior</a>
                        </li>
                    {{/if}}

                    {{#each (range 1 totalPaginas)}}
                        <li class="page-item {{#if (eq this ../paginaActual)}}active{{/if}}">
                            <a class="page-link" href="/api/hechos?page={{this}}">{{this}}</a>
                        </li>
                    {{/each}}

                    {{#if (lt paginaActual totalPaginas)}}
                        <li class="page-item">
                            <a class="page-link" href="/api/hechos?page={{add paginaActual 1}}">Siguiente</a>
                        </li>
                    {{/if}}
                </ul>
            </nav>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const categoriaSelect = document.getElementById('categoriaSelect');
            const soloConsensuados = document.getElementById('soloConsensuados');
            const resultsList = document.getElementById('resultsList');
            const paginationContainer = document.getElementById('paginationContainer');

            function formatDate(dateString, format) {
                if (!dateString) return '';
                const date = new Date(dateString);

                if (format === 'dd/MM/yyyy HH:mm') {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                return date.toLocaleDateString('es-AR');
            }

            async function buscarHechos(titulo, categoria, consensuados = false, page = 1) {
                resultsList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Buscando...</p></div>';
                paginationContainer.style.display = 'none';

                try {
                    const params = new URLSearchParams();
                    if (titulo) params.append('titulo', titulo);
                    if (categoria && categoria !== "0") params.append('categoria', categoria);
                    if (consensuados) params.append('soloConsensuados', 'true');
                    params.append('page', page);
                    params.append('pageSize', 15);
                    params.append('paginar', 'true');

                    const url = `/api/hechos/buscar-completo?${params.toString()}`;
                    const resp = await fetch(url);

                    if (!resp.ok) {
                        throw new Error('Error en la búsqueda');
                    }

                    const data = await resp.json();
                    const hechosResultantes = data.resultados || [];
                    const total = data.total || 0;
                    const paginaActual = data.paginaActual || 1;
                    const totalPaginas = data.totalPaginas || 1;

                    resultsList.innerHTML = '';

                    if (hechosResultantes.length === 0) {
                        resultsList.innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                No se encontraron hechos con los criterios de búsqueda
                            </div>
                        `;
                        actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados);
                        return;
                    }

                    const resumen = document.createElement('div');
                    resumen.className = 'alert alert-light mb-3';
                    resumen.innerHTML = `
                        <small>
                            <i class="fa-solid fa-filter me-1"></i>
                            <strong>${total} resultado(s)</strong>
                            <span class="ms-2">
                                ${titulo ? `Título: "${titulo}" • ` : ''}
                                ${categoria && categoria !== "0" ? `Categoría: ${categoria} • ` : ''}
                                ${consensuados ? 'Solo consensuados' : ''}
                            </span>
                        </small>
                    `;
                    resultsList.appendChild(resumen);

                    hechosResultantes.forEach(hecho => {
                        const etiquetasHTML = hecho.etiquetas && hecho.etiquetas.length > 0
                            ? hecho.etiquetas.map(e => `<span class="badge bg-secondary">${e.nombre}</span>`).join(' ')
                            : '';

                        const esConsensuado = hecho.colecciones && hecho.colecciones.length > 0;
                        const fechaFormateada = formatDate(hecho.hecho_fecha_suceso, 'dd/MM/yyyy HH:mm');

                        const itemHTML = `
                            <a href="/hechos/${hecho.id}" class="list-group-item list-group-item-action py-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <h6 class="fw-bold text-dark mb-0 me-2">${hecho.hecho_titulo}</h6>
                                            ${esConsensuado ? '<span class="badge bg-success" title="Hecho consensuado">✓</span>' : ''}
                                        </div>
                                        <p class="mb-2 text-muted small">${hecho.hecho_descripcion || 'Sin descripción'}</p>
                                        <div class="mb-2">
                                            <span class="badge bg-info text-dark">${hecho.hecho_categoria || 'General'}</span>
                                            ${etiquetasHTML}
                                        </div>
                                        <div class="small text-muted">
                                            <i class="fa-regular fa-calendar me-1"></i>
                                            ${fechaFormateada}
                                            <span class="mx-2">•</span>
                                            <i class="fa-solid fa-location-dot me-1"></i>
                                            ${hecho.hecho_provincia || 'S/D'} — ${hecho.hecho_direccion || 'Ubicación no especificada'}
                                        </div>
                                    </div>
                                    <div class="ms-3">
                                        <i class="fa-solid fa-chevron-right text-muted"></i>
                                    </div>
                                </div>
                            </a>
                        `;
                        resultsList.insertAdjacentHTML('beforeend', itemHTML);
                    });

                    actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados);

                } catch (error) {
                    console.error(error);
                    resultsList.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            Ocurrió un error en la búsqueda: ${error.message}
                        </div>
                    `;
                }
            }

            function actualizarPaginacion(paginaActual, totalPaginas, titulo, categoria, consensuados) {
                paginationContainer.innerHTML = '';
                paginationContainer.style.display = totalPaginas > 1 ? 'flex' : 'none';

                if (paginaActual > 1) {
                    const prevLi = document.createElement('li');
                    prevLi.className = 'page-item';
                    prevLi.innerHTML = `
                        <a class="page-link" href="#" data-page="${paginaActual - 1}">Anterior</a>
                    `;
                    paginationContainer.appendChild(prevLi);
                }

                const startPage = Math.max(1, paginaActual - 2);
                const endPage = Math.min(totalPaginas, paginaActual + 2);

                for (let i = startPage; i <= endPage; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
                    li.innerHTML = `
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    `;
                    paginationContainer.appendChild(li);
                }

                if (paginaActual < totalPaginas) {
                    const nextLi = document.createElement('li');
                    nextLi.className = 'page-item';
                    nextLi.innerHTML = `
                        <a class="page-link" href="#" data-page="${paginaActual + 1}">Siguiente</a>
                    `;
                    paginationContainer.appendChild(nextLi);
                }

                document.querySelectorAll('.pagination .page-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        buscarHechos(titulo, categoria, consensuados, page);

                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    });
                });
            }

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const titulo = searchInput.value.trim();
                const categoria = categoriaSelect.value;
                const consensuados = soloConsensuados.checked;

                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('titulo', titulo);
                urlParams.set('categoria', categoria);
                urlParams.set('soloConsensuados', consensuados);

                history.replaceState(null, '', `${window.location.pathname}?${urlParams.toString()}`);

                buscarHechos(titulo, categoria, consensuados);
            });

            const urlParams = new URLSearchParams(window.location.search);
            const tituloInicial = urlParams.get('titulo') || '';
            const categoriaInicial = urlParams.get('categoria') || '0';
            const consensuadosInicial = urlParams.get('soloConsensuados') === 'true';

            searchInput.value = tituloInicial;
            categoriaSelect.value = categoriaInicial;
            soloConsensuados.checked = consensuadosInicial;

            if (tituloInicial || categoriaInicial !== '0' || consensuadosInicial) {
                buscarHechos(tituloInicial, categoriaInicial, consensuadosInicial);
            } else {
                const initialPage = parseInt(urlParams.get('page')) || 1;
                buscarHechos('', '0', false, initialPage);
            }
        });
    </script>

{{/partial}}

{{> templates/layout}}