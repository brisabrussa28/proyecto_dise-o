{{#partial "nav_izquierda"}}
    <a href="/admin/dashboard" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
       title="Volver al panel">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="d-none d-sm-block">Volver</span>
    </a>
{{/partial}}

{{#partial "contenido"}}

    <body class="principal" style="background-color: white;">

    <h1 style="font-weight: 700; font-size: 32px; color: black; padding-left: 8px; padding-top: 10px; margin-left: 2%; margin-bottom: 2%;">
        <i class="bi bi-kanban" style="transform: rotate(180deg); display: inline-block;"></i>
        Estadísticas
    </h1>

    <div class="d-flex flex-column align-items-center" style="padding: 10px; gap: 27px;">

        <div class="d-flex flex-row align-items-center" style="gap: 27px;">

            <div class="d-flex flex-column align-items-center stats_recuadro">
                <h1 style="font-size: 1.35vw; font-weight: 700; color: #005baa;">Hechos totales</h1>
                <h2 style="font-size: 2.25vw; font-weight: bold; color: #005baa;">
                    {{#each cantidadHechos}}{{estadistica_cantidad}}{{/each}}
                </h2>
            </div>

            <div class="d-flex flex-column align-items-center stats_recuadro">
                <h1 style="font-size: 1.35vw; font-weight: 700; color: #005baa;">Solicitudes Pendientes</h1>
                <h2 style="font-size: 2.25vw; font-weight: bold; color: #005baa;">
                    {{#each solicitudesPendientes}}{{estadistica_cantidad}}{{/each}}
                </h2>
            </div>

            <div class="d-flex flex-column align-items-center stats_recuadro">
                <h1 style="font-size: 1.35vw; font-weight: 700; color: #005baa;">Solicitudes Spam</h1>
                <h2 style="font-size: 2.25vw; font-weight: bold; color: #005baa;">
                    {{#each solicitudesSpam}}{{estadistica_cantidad}}{{/each}}
                </h2>
            </div>

        </div>

        <div class="d-flex flex-column" style="padding-top: 25px; gap: 35px; border-top: solid 3px #005baa; width: 94vw;">

            <div class="accordion" id="accordionExample" style="width: 94vw;">

                <div class="accordion-item" style="padding-bottom: 4vh;">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed btn btn-light btn-white-to-gray bot-stats"
                                type="button" data-bs-toggle="collapse"
                                data-bs-target="#provinciaCategoria"
                                aria-expanded="false"
                                style="font-size: 25px;">
                            <strong>Hechos por Provincia y Categoría</strong>
                        </button>
                    </h2>

                    <div id="provinciaCategoria" class="accordion-collapse collapse">
                        <div class="accordion-body">

                            <div class="mb-3">
                                <label class="form-label">Categoría:</label>
                                <select id="categoriaProvincia" class="form-select" style="width: 20vw;">
                                    <option value="">Todas</option>
                                    {{#each categorias}}
                                        <option value="{{this}}">{{this}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <canvas id="chartProvinciaCategoria" class="stats_grafico" height="13vw" width="69vw"></canvas>
                        </div>
                    </div>
                </div>

                <div class="accordion-item" style="padding-bottom: 4vh;">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed btn btn-light btn-white-to-gray bot-stats"
                                type="button" data-bs-toggle="collapse"
                                data-bs-target="#horaCategoria"
                                aria-expanded="false"
                                style="font-size: 25px;">
                            <strong>Hechos por Hora y Categoría</strong>
                        </button>
                    </h2>

                    <div id="horaCategoria" class="accordion-collapse collapse">
                        <div class="accordion-body">

                            <div class="mb-3">
                                <label class="form-label">Categoría:</label>
                                <select id="categoriaHora" class="form-select" style="width: 20vw;">
                                    <option value="">Todas</option>
                                    {{#each categorias}}
                                        <option value="{{this}}">{{this}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <canvas id="chartHoraCategoria" class="stats_grafico" height="13vw" width="69vw"></canvas>
                        </div>
                    </div>
                </div>

                <div class="accordion-item" style="padding-bottom: 4vh;">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed btn btn-light btn-white-to-gray bot-stats"
                                type="button" data-bs-toggle="collapse"
                                data-bs-target="#hechosCategoria"
                                aria-expanded="false"
                                style="font-size: 25px;">
                            <strong>Hechos Reportados por Categoría</strong>
                        </button>
                    </h2>

                    <div id="hechosCategoria" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <canvas id="chartHechosCategoria" class="stats_grafico_dos" height="30vw" width="69vw"></canvas>
                        </div>
                    </div>
                </div>

                <div class="accordion-item" style="padding-bottom: 4vh;">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed btn btn-light btn-white-to-gray bot-stats"
                                type="button" data-bs-toggle="collapse"
                                data-bs-target="#provinciaColeccion"
                                aria-expanded="false"
                                style="font-size: 25px;">
                            <strong>Hechos Reportados por Provincia y Colección</strong>
                        </button>
                    </h2>

                    <div id="provinciaColeccion" class="accordion-collapse collapse">
                        <div class="accordion-body">

                            <div class="mb-3">
                                <label for="selectColeccion" class="form-label">Seleccionar colección:</label>
                                <select id="selectColeccion" class="form-select" style="width: 20vw;">
                                    <option value="">Elegir colección</option>
                                    {{#each colecciones}}
                                        <option value="{{coleccion_id}}">{{coleccion_titulo}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <canvas id="chartProvinciaColeccion" class="stats_grafico_dos" height="30vw" width="69vw"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    </body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

    <script>
        let chartProvinciaCategoria = null;
        let chartHoraCategoria = null;
        let chartHechosCategoria = null;
        let chartProvinciaColeccion = null;

        function crearGrafico(id, datos, label) {
            const ctx = document.getElementById(id).getContext('2d');

            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datos.map(e => e.grupo || e.categoria),
                    datasets: [{
                        label: label,
                        data: datos.map(e => e.cantidad),
                        backgroundColor: 'rgba(0, 91, 170, 0.7)'
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        document.getElementById("provinciaCategoria").addEventListener("shown.bs.collapse", cargarProvinciaCategoria);
        document.getElementById("categoriaProvincia").addEventListener("change", cargarProvinciaCategoria);

        async function cargarProvinciaCategoria() {
            const categoria = document.getElementById("categoriaProvincia").value;
            const resp = await fetch(`/admin/estadisticas/provincia?categoria=${categoria}`);
            const datos = await resp.json();

            if (chartProvinciaCategoria) chartProvinciaCategoria.destroy();
            chartProvinciaCategoria = crearGrafico("chartProvinciaCategoria", datos, "Hechos por provincia");
        }

        document.getElementById("horaCategoria").addEventListener("shown.bs.collapse", cargarHoraCategoria);
        document.getElementById("categoriaHora").addEventListener("change", cargarHoraCategoria);

        async function cargarHoraCategoria() {
            const categoria = document.getElementById("categoriaHora").value;
            const resp = await fetch(`/admin/estadisticas/hora?categoria=${categoria}`);
            const datos = await resp.json();

            if (chartHoraCategoria) chartHoraCategoria.destroy();
            chartHoraCategoria = crearGrafico("chartHoraCategoria", datos, "Hechos por hora");
        }

        document.getElementById("selectColeccion").addEventListener("change", async () => {
            const id = selectColeccion.value;
            if (!id) return;

            const resp = await fetch(`/admin/estadisticas/coleccion/${id}`);
            const datos = await resp.json();

            if (chartProvinciaColeccion) chartProvinciaColeccion.destroy();
            chartProvinciaColeccion = crearGrafico("chartProvinciaColeccion", datos, "Hechos por provincia (colección)");
        });
    </script>

{{/partial}}

{{> templates/layout}}