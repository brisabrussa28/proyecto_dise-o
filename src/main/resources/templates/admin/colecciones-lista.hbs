{{#partial "nav_izquierda"}}
    <a href="/" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
        <i class="fa-solid fa-arrow-left"></i>
        <span class="d-none d-sm-block">Volver al Inicio</span>
    </a>
{{/partial}}

{{#partial "contenido"}}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-light text-dark mb-0">Gestión de Colecciones</h2>
            <p class="text-muted small mb-0">Agrupa hechos de distintas fuentes y define criterios de consenso.</p>
        </div>
    </div>

    <div class="row g-4">

        <!-- COLUMNA IZQUIERDA: CREACIÓN -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white py-3">
                    <h6 class="mb-0 fw-bold small text-uppercase">
                        <i class="fa-solid fa-plus-circle me-2"></i>Nueva Colección
                    </h6>
                </div>
                <div class="card-body bg-light">

                    <form action="/admin/colecciones" method="POST" enctype="multipart/form-data" id="formCrearColeccion" onsubmit="prepararEnvioMapeo()">

                        <!-- 1. Datos Básicos -->
                        <div class="bg-white p-3 rounded shadow-sm mb-3 border">
                            <h6 class="small fw-bold text-muted mb-3 border-bottom pb-2">Datos Generales</h6>
                            <div class="mb-2">
                                <label class="form-label x-small fw-bold text-secondary text-uppercase">Nombre</label>
                                <input type="text" name="nombre" class="form-control form-control-sm" placeholder="Ej: Accidentes 2023" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label x-small fw-bold text-secondary text-uppercase">Categoría</label>
                                <input type="text" name="categoria" class="form-control form-control-sm" placeholder="Ej: Tráfico">
                            </div>
                            <div class="mb-0">
                                <label class="form-label x-small fw-bold text-secondary text-uppercase">Descripción</label>
                                <textarea name="descripcion" class="form-control form-control-sm" rows="2"></textarea>
                            </div>
                        </div>

                        <!-- 2. Selección de Fuente -->
                        <div class="bg-white p-3 rounded shadow-sm mb-3 border">
                            <h6 class="small fw-bold text-muted mb-3 border-bottom pb-2">Fuente de Datos</h6>

                            <!-- Toggle Fuente -->
                            <div class="d-flex justify-content-center mb-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="modo_fuente" id="modoExistente" value="existente" checked onchange="togglemodo_fuente()">
                                    <label class="btn btn-outline-primary btn-sm" for="modoExistente">Existente</label>

                                    <input type="radio" class="btn-check" name="modo_fuente" id="modoNueva" value="nueva" onchange="togglemodo_fuente()">
                                    <label class="btn btn-outline-primary btn-sm" for="modoNueva">Crear Nueva</label>
                                </div>
                            </div>

                            <!-- A) Fuente Existente -->
                            <div id="panelFuenteExistente">
                                <select name="fuente_id" class="form-select form-select-sm">
                                    <option value="" selected disabled>Seleccionar fuente...</option>
                                    {{#each fuentes}}
                                        <option value="{{this.id}}">{{this.nombre}} ({{this.tipo}})</option>
                                    {{/each}}
                                </select>
                            </div>

                            <!-- B) Fuente Nueva -->
                            <div id="panelFuenteNueva" class="d-none">
                                <div class="mb-2">
                                    <label class="form-label x-small fw-bold">Nombre Fuente</label>
                                    <input type="text" name="nueva_fuente_nombre" class="form-control form-control-sm">
                                </div>

                                <div class="mb-2">
                                    <label class="form-label x-small fw-bold">Tipo</label>
                                    <select id="selectorTipoUI" class="form-select form-select-sm" onchange="gestionarCambioTipo()">
                                        <option value="DINAMICA" selected>Dinámica (Vacía)</option>
                                        <option value="ESTATICA_CSV">Importar CSV</option>
                                        <option value="ESTATICA_JSON">Importar JSON</option>
                                        <option value="API">API Externa</option>
                                        <option value="AGREGACION">Agregación</option>
                                    </select>
                                    <input type="hidden" name="nueva_fuente_tipo" id="inputTipoReal" value="DINAMICA">
                                </div>

                                <!-- Sub-formularios -->
                                <div id="camposApi" class="d-none bg-light p-2 rounded border mb-2">
                                    <input type="text" name="url" class="form-control form-control-sm mb-1" placeholder="URL Endpoint (http://...)">
                                    <input type="text" name="token" class="form-control form-control-sm" placeholder="Token Auth (Opcional)">
                                </div>

                                <div id="camposEstatica" class="d-none bg-light p-2 rounded border mb-2">
                                    <!-- CSV Config -->
                                    <div id="configCsv" class="d-none row g-2 mb-2">
                                        <div class="col-6">
                                            <label class="form-label x-small mb-0">Separador</label>
                                            <select name="csv_separador" class="form-select form-select-sm py-0" style="font-size: 0.8rem;">
                                                <option value="," selected>Coma (,)</option>
                                                <option value=";">Punto y coma (;)</option>
                                                <option value="|">Barra (|)</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label x-small mb-0">Formato Fecha</label>
                                            <input type="text" name="csv_formato_fecha" class="form-control form-control-sm py-0" value="dd/MM/yyyy HH:mm" style="font-size: 0.8rem;">
                                        </div>
                                    </div>

                                    <input type="file" name="archivo_fuente" id="inputArchivo" class="form-control form-control-sm mb-2">

                                    <!-- Mapeo Dinámico -->
                                    <div id="seccionMapeo" class="d-none border-top pt-2 mt-2">
                                        <h6 class="x-small fw-bold text-success mb-2"><i class="fa-solid fa-table-columns me-1"></i>Mapear Columnas CSV</h6>
                                        <div id="contenedorFilasMapeo" class="d-grid gap-1"></div>
                                    </div>
                                    <input type="hidden" name="mapeo_columnas_json" id="inputMapeoJson">
                                </div>

                                <div id="camposAgregacion" class="d-none bg-light p-2 rounded border mb-2">
                                    <label class="form-label x-small">Fuentes a agrupar</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <select id="selectFuenteAgregacion" class="form-select">
                                            {{#each fuentes}}
                                                <option value="{{this.id}}">{{this.nombre}}</option>
                                            {{/each}}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary" onclick="agregarFuenteAgregacion()">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                    <ul id="listaAgregacion" class="list-group list-group-flush border rounded bg-white small" style="max-height: 100px; overflow-y: auto;">
                                        <li class="list-group-item text-center text-muted fst-italic py-1" id="placeholder-agregacion">Ninguna</li>
                                    </ul>
                                    <div id="inputsAgregacionContainer"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Algoritmo -->
                        <div class="bg-white p-3 rounded shadow-sm mb-3 border">
                            <h6 class="small fw-bold text-muted mb-2">Consenso</h6>
                            <select name="algoritmo_tipo" class="form-select form-select-sm">
                                <option value="May_simple">Mayoría Simple</option>
                                <option value="Absoluta">Unanimidad / Absoluta</option>
                                <option value="Mult_menciones">Múltiples Menciones</option>
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary fw-bold">
                                Crear Colección
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: LISTADO -->
        <div class="col-lg-7">

            <!-- Buscador -->
            <form id="searchForm" class="card border-0 shadow-sm p-3 mb-4">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                            <input id="searchInput" type="text" name="titulo" class="form-control border-start-0 ps-0" placeholder="Buscar por título..." value="{{query}}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="categoriaSelect" name="categoria">
                            <option value="0">Todas las Categorías</option>
                            {{#each categorias}}
                                <option value="{{this}}" {{#if (eq this ../categoriaSeleccionada)}}selected{{/if}}>{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-dark w-100" type="submit">Filtrar</button>
                    </div>
                </div>
            </form>

            <!-- Lista -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-uppercase text-muted small">Colecciones Disponibles</h6>
                </div>
                <div class="list-group list-group-flush" id="resultsList">
                    {{#each colecciones}}
                        <div class="list-group-item list-group-item-action p-3">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <h6 class="mb-0 fw-bold text-primary">{{this.titulo}}</h6>
                                        <span class="badge bg-light text-dark border">{{this.categoria}}</span>
                                    </div>
                                    <small class="text-muted d-block text-truncate" style="max-width: 400px;">
                                        {{#if this.descripcion}}{{this.descripcion}}{{else}}Sin descripción{{/if}}
                                    </small>
                                </div>
                                <a href="/admin/colecciones/{{this.id}}" class="btn btn-sm btn-outline-dark rounded-pill px-3">
                                    Configurar <i class="fa-solid fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    {{else}}
                        <div class="text-center py-5 text-muted">
                            <i class="fa-regular fa-folder-open fa-2x mb-3 opacity-25"></i>
                            <p class="mb-0">No se encontraron colecciones.</p>
                        </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts Lógicos (Mantienen funcionalidad original pero adaptada) -->
<script>
    const CAMPOS_SISTEMA = [
        { id: "TITULO", label: "Título", required: true },
        { id: "FECHA_SUCESO", label: "Fecha", required: true },
        { id: "CATEGORIA", label: "Categoría", required: false },
        { id: "DESCRIPCION", label: "Descrip.", required: false },
        { id: "DIRECCION", label: "Dirección", required: false },
        { id: "PROVINCIA", label: "Provincia", required: false },
        { id: "LATITUD", label: "Lat", required: false },
        { id: "LONGITUD", label: "Lng", required: false },
        { id: "ETIQUETAS", label: "Tags", required: false },
        { id: "FOTOS", label: "Fotos", required: false }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        togglemodo_fuente();
        gestionarCambioTipo();

        const inputArchivo = document.getElementById('inputArchivo');
        if (inputArchivo) inputArchivo.addEventListener('change', procesarArchivo);
    });

    function togglemodo_fuente() {
        const modoNueva = document.getElementById('modoNueva').checked;
        const panelExistente = document.getElementById('panelFuenteExistente');
        const panelNueva = document.getElementById('panelFuenteNueva');
        const selectExistente = document.querySelector('select[name="fuente_id"]');
        const inputNombreNueva = document.querySelector('input[name="nueva_fuente_nombre"]');

        if (modoNueva) {
            panelExistente.classList.add('d-none');
            panelNueva.classList.remove('d-none');
            selectExistente.disabled = true;
            inputNombreNueva.required = true;
        } else {
            panelExistente.classList.remove('d-none');
            panelNueva.classList.add('d-none');
            selectExistente.disabled = false;
            inputNombreNueva.required = false;
        }
    }

    function gestionarCambioTipo() {
        const valorUI = document.getElementById('selectorTipoUI').value;
        const realInput = document.getElementById('inputTipoReal');

        // Reset
        ['camposApi', 'camposEstatica', 'camposAgregacion', 'configCsv', 'seccionMapeo'].forEach(id =>
            document.getElementById(id).classList.add('d-none')
        );

        if (valorUI === 'ESTATICA_CSV') {
            realInput.value = 'ESTATICA';
            document.getElementById('camposEstatica').classList.remove('d-none');
            document.getElementById('configCsv').classList.remove('d-none');
            document.getElementById('inputArchivo').accept = ".csv";
        } else if (valorUI === 'ESTATICA_JSON') {
            realInput.value = 'ESTATICA';
            document.getElementById('camposEstatica').classList.remove('d-none');
            document.getElementById('inputArchivo').accept = ".json";
        } else if (valorUI === 'API') {
            realInput.value = 'API';
            document.getElementById('camposApi').classList.remove('d-none');
        } else if (valorUI === 'AGREGACION') {
            realInput.value = 'AGREGACION';
            document.getElementById('camposAgregacion').classList.remove('d-none');
        } else {
            realInput.value = 'DINAMICA';
        }
    }

    function procesarArchivo(e) {
        const file = e.target.files[0];
        const tipo = document.getElementById('selectorTipoUI').value;
        if (!file || tipo !== 'ESTATICA_CSV') return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            const lines = evt.target.result.split('\n');
            if (lines.length > 0) {
                const sep = document.querySelector('select[name="csv_separador"]').value;
                const headers = lines[0].split(sep).map(h => h.trim().replace(/^"|"$/g, ''));
                generarMapeo(headers);
                document.getElementById('seccionMapeo').classList.remove('d-none');
            }
        };
        reader.readAsText(file);
    }

    function generarMapeo(headers) {
        const cont = document.getElementById('contenedorFilasMapeo');
        cont.innerHTML = '';
        const opts = headers.map(h => `<option value="${h}">${h}</option>`).join('');

        CAMPOS_SISTEMA.forEach(c => {
            const div = document.createElement('div');
            div.className = 'row g-1 align-items-center mb-1';
            div.innerHTML = `
                <div class="col-4 text-end"><label class="x-small fw-bold mb-0 text-muted">${c.label}</label></div>
                <div class="col-8">
                    <select class="form-select form-select-sm py-0 select-mapeo" style="font-size:0.75rem" data-campo="${c.id}" ${c.required ? 'required' : ''}>
                        <option value="">Ignorar</option>
                        ${opts}
                    </select>
                </div>
            `;
            cont.appendChild(div);
        });
    }

    function prepararEnvioMapeo() {
        const modoNueva = document.getElementById('modoNueva').checked;
        const tipo = document.getElementById('selectorTipoUI').value;
        if (!modoNueva || tipo !== 'ESTATICA_CSV') {
            document.getElementById('inputMapeoJson').value = "";
            return;
        }

        const map = {};
        document.querySelectorAll('.select-mapeo').forEach(s => {
            if(s.value) map[s.dataset.campo] = [s.value];
        });
        document.getElementById('inputMapeoJson').value = JSON.stringify(map);
    }

    // Funciones de Agregación
    function agregarFuenteAgregacion() {
        const sel = document.getElementById('selectFuenteAgregacion');
        const id = sel.value;
        const txt = sel.options[sel.selectedIndex].text;
        if (!id || document.getElementById('agg-'+id)) return;

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between py-1';
        li.innerHTML = `<span>${txt}</span> <button type="button" class="btn btn-link text-danger p-0" onclick="this.parentElement.remove(); document.getElementById('agg-${id}').remove();"><i class="fa-solid fa-times"></i></button>`;
        document.getElementById('listaAgregacion').appendChild(li);
        document.getElementById('placeholder-agregacion').classList.add('d-none');

        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = 'fuentes_seleccionadas'; inp.value = id; inp.id = 'agg-'+id;
        document.getElementById('inputsAgregacionContainer').appendChild(inp);
    }

    // Búsqueda (Preservada del original)
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const titulo = document.getElementById('searchInput').value;
        const cat = document.getElementById('categoriaSelect').value;
        const list = document.getElementById('resultsList');

        list.innerHTML = '<div class="text-center p-3 text-muted"><i class="fa-solid fa-spinner fa-spin me-2"></i>Buscando...</div>';

        try {
            const res = await fetch(`/api/admin/colecciones/buscar?titulo=${encodeURIComponent(titulo)}&categoria=${encodeURIComponent(cat)}`);
            const data = await res.json();
            list.innerHTML = '';

            if(data.length === 0) {
                list.innerHTML = '<div class="text-center p-4 text-muted">No se encontraron resultados.</div>';
                return;
            }

            data.forEach(c => {
                list.innerHTML += `
                    <div class="list-group-item list-group-item-action p-3">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold text-primary">${c.titulo || c.coleccion_titulo}</h6>
                                <span class="badge bg-light text-dark border mt-1">${c.categoria || c.coleccion_categoria}</span>
                            </div>
                            <a href="/admin/colecciones/${c.id}" class="btn btn-sm btn-outline-dark rounded-pill px-3">
                                Configurar <i class="fa-solid fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>`;
            });
        } catch (err) {
            list.innerHTML = `<div class="alert alert-danger m-3">Error: ${err.message}</div>`;
        }
    });
</script>
{{/partial}}
{{> templates/layout}}