{{#partial "nav_izquierda"}}
    <button class="btn btn-outline-light btn-sm d-flex align-items-center gap-2"
            onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
        <span class="d-none d-md-inline">Volver</span>
    </button>
{{/partial}}

{{#partial "contenido"}}
    <div class="container-sm py-4 mx-auto">

        {{#if error}}
            <div class="alert alert-danger alert-dismissible fade show shadow-sm mb-4" role="alert">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>
                <strong>¡Error!</strong> {{error}}
                <button type="button" class="btn-close" data-bs-dismiss="alert"
                        aria-label="Close"></button>
            </div>
        {{/if}}

        <div class="bg-white bg-opacity-75 p-3 rounded shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 border-secondary border-opacity-25">
                <div>
                    <h2 class="fw-bold"><i class="fa-solid fa-server me-2"></i>Gestión de Fuentes
                    </h2>
                </div>
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseCrear" aria-expanded="false">
                    <i class="fa-solid fa-plus me-2"></i>Nueva Fuente
                </button>
            </div>

            <div class="collapse mb-4" id="collapseCrear">
                <div class="card border-0 shadow bg-light">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0 fw-bold small text-uppercase">Alta de Fuente</h6>
                    </div>
                    <div class="card-body">
                        <form action="/admin/fuentes" method="POST" enctype="multipart/form-data"
                              id="formCrearFuente" class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Nombre de la Fuente</label>
                                <input type="text" name="nueva_fuente_nombre" class="form-control"
                                       placeholder="Ej: Reporte Policial 2024" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Tipo de Origen</label>
                                <select id="selectorTipoFuente" class="form-select"
                                        onchange="cambiarTipoFuente()">
                                    <option value="DINAMICA" selected>Dinámica (Manual)</option>
                                    <option value="ESTATICA_CSV">Importar CSV</option>
                                    <option value="ESTATICA_JSON">Importar JSON</option>
                                    <option value="API">API Externa</option>
                                    <option value="AGREGACION">Agregación</option>
                                </select>
                                <input type="hidden" name="nueva_fuente_tipo"
                                       id="inputTipoFuenteReal" value="DINAMICA">
                            </div>

                            <div class="col-12 mt-3">

                                <div id="panelEstatica" class="d-none bg-white p-3 rounded border">
                                    <h6 class="small fw-bold border-bottom pb-2 mb-3">Configuración
                                        de Archivo</h6>

                                    <div id="configCsv" class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label x-small text-muted mb-0">Separador</label>
                                            <select name="csv_separador"
                                                    class="form-select form-select-sm">
                                                <option value=",">Coma (,)</option>
                                                <option value=";">Punto y coma (;)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label x-small text-muted mb-0">Formato
                                                Fecha</label>
                                            <input type="text" name="csv_formato_fecha"
                                                   class="form-control form-control-sm"
                                                   value="dd/MM/yyyy HH:mm">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Archivo de
                                            Datos</label>
                                        <input type="file" name="archivo_fuente" id="inputArchivo"
                                               class="form-control">
                                    </div>

                                    <div id="areaMapeo" class="d-none mt-3 pt-2 border-top">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-success">Archivo Leído</span>
                                            <small class="text-muted">Asigna las columnas del
                                                archivo a los campos del sistema.</small>
                                        </div>
                                        <div id="gridMapeo" class="row g-2"></div>
                                    </div>
                                    <small class="text-muted">*: Campo obligatorio</small>
                                    <div>
                                        <small class="text-muted">Mientras más columnas asignes más
                                            preciso es el mapeo</small>
                                    </div>
                                </div>

                                <div id="panelApi" class="d-none bg-white p-3 rounded border">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label class="form-label small fw-bold">URL
                                                Endpoint</label>
                                            <input type="url" name="url" class="form-control"
                                                   placeholder="https://api.ejemplo.com/v1/incidentes">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold">Token
                                                (Bearer)</label>
                                            <input type="text" name="token" class="form-control"
                                                   placeholder="Opcional">
                                        </div>
                                    </div>
                                </div>

                                <div id="panelAgg" class="d-none bg-white p-3 rounded border">
                                    <label class="form-label small fw-bold">Fuentes hijas:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        {{#each fuentes}}
                                            <div class="form-check form-check-inline border rounded px-3 py-1 m-0">
                                                <input class="form-check-input" type="checkbox"
                                                       name="fuentes_seleccionadas"
                                                       value="{{this.id}}" id="chk-{{this.id}}">
                                                <label class="form-check-label small"
                                                       for="chk-{{this.id}}">{{this.nombre}}</label>
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>

                            </div>

                            <input type="hidden" name="mapeo_columnas_json" id="jsonMapeo">

                            <div class="col-12 text-end">
                                <button type="button"
                                        class="btn btn-link text-muted text-decoration-none me-2"
                                        data-bs-toggle="collapse" data-bs-target="#collapseCrear">
                                    Cancelar
                                </button>
                                <button type="button" class="btn btn-success fw-bold px-4"
                                        id="btnCrearFuente">Crear Fuente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                {{#each fuentes}}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title fw-bold text-dark mb-0 text-truncate"
                                        title="{{this.nombre}}">{{this.nombre}}</h5>
                                    <div class="text-muted">
                                        {{#if (eq this.tipo "DINAMICA")}}
                                            <i class="fa-solid fa-pen-to-square"
                                               title="Dinámica"></i>{{/if}}
                                        {{#if (eq this.tipo "ESTATICA")}}
                                            <i class="fa-solid fa-file-csv"
                                               title="Estática"></i>{{/if}}
                                        {{#if (eq this.tipo "API")}}
                                            <i class="fa-solid fa-cloud" title="API"></i>{{/if}}
                                        {{#if (eq this.tipo "AGREGACION")}}
                                            <i class="fa-solid fa-layer-group"
                                               title="Agregación"></i>{{/if}}
                                    </div>
                                </div>
                                <p class="card-text small text-muted mb-3">
                                    ID: #{{this.id}} <br>
                                    Tipo: <span
                                        class="badge bg-light text-dark border">{{this.tipo}}</span>
                                </p>
                                <div class="d-grid">
                                    <a href="/admin/fuentes/{{this.id}}"
                                       class="btn btn-outline-primary btn-sm rounded-pill">
                                        Administrar <i class="fa-solid fa-chevron-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>

    <style>
        .hover-shadow:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
        }

        .transition-all {
            transition: all 0.3s ease;
        }

        .border-dashed {
            border-style: dashed !important;
        }
    </style>

    <div class="modal fade" id="modalExitoFuente" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title"><i class="fa-solid fa-circle-check me-2"></i>Creando Fuente...</h5>
                </div>
                <div class="modal-body text-center p-4">
                    <p class="fw-bold mb-3">Se estan validando los datos...</p>
                    <div class="d-flex justify-content-center mt-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function cambiarTipoFuente() {
            const val = document.getElementById('selectorTipoFuente').value;
            const real = document.getElementById('inputTipoFuenteReal');

            // Paneles principales
            const panelEstatica = document.getElementById('panelEstatica');
            const panelApi = document.getElementById('panelApi');
            const panelAgg = document.getElementById('panelAgg');

            // Sub-elementos de estática
            const configCsv = document.getElementById('configCsv');
            const inputArchivo = document.getElementById('inputArchivo');
            const areaMapeo = document.getElementById('areaMapeo');

            // Reset visibilidad
            [panelEstatica, panelApi, panelAgg].forEach(el => el.classList.add('d-none'));
            configCsv.classList.add('d-none');
            areaMapeo.classList.add('d-none');

            if (val === 'ESTATICA_CSV') {
                real.value = 'ESTATICA';
                panelEstatica.classList.remove('d-none');
                configCsv.classList.remove('d-none'); // Mostrar config CSV
                inputArchivo.accept = ".csv";
            } else if (val === 'ESTATICA_JSON') {
                real.value = 'ESTATICA';
                panelEstatica.classList.remove('d-none');
                // CSV oculto, Mapeo oculto (se usa default del backend)
                inputArchivo.accept = ".json";
            } else if (val === 'API') {
                real.value = 'API';
                panelApi.classList.remove('d-none');
            } else if (val === 'AGREGACION') {
                real.value = 'AGREGACION';
                panelAgg.classList.remove('d-none');
            } else {
                real.value = 'DINAMICA';
            }
        }

        // --- LÓGICA CSV (Solo se activa si el tipo es CSV) ---
        const inputArchivo = document.getElementById('inputArchivo');
        if (inputArchivo) {
            inputArchivo.addEventListener('change', function (e) {
                const tipo = document.getElementById('selectorTipoFuente').value;
                // Si NO es CSV, no hacemos mapeo frontend (igual que en colecciones)
                if (tipo !== 'ESTATICA_CSV') return;

                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (evt) {
                    const lines = evt.target.result.split('\n');
                    if (lines.length > 0) {
                        const sep = document.querySelector('select[name="csv_separador"]').value;
                        const headers = lines[0].split(sep).map(h => h.trim().replace(/^"|"$/g, ''));
                        dibujarMapeo(headers);
                        document.getElementById('areaMapeo').classList.remove('d-none');
                    }
                };
                reader.readAsText(file);
            });
        }

        function dibujarMapeo(headers) {
            const grid = document.getElementById('gridMapeo');
            grid.innerHTML = '';

            // Usamos las claves que coinciden con Hecho.java (@JsonProperty)
            const campos = [
                {k: 'TITULO', l: 'Título *'},
                {k: 'FECHA_SUCESO', l: 'Fecha *'},
                {k: 'LATITUD', l: 'Latitud *'},
                {k: 'LONGITUD', l: 'Longitud *'},
                {k: 'DESCRIPCION', l: 'Descrip.'},
                {k: 'CATEGORIA', l: 'Categoría'},
                {k: 'DIRECCION', l: 'Dirección *'},
                {k: 'PROVINCIA', l: 'Provincia'}
            ];

            const optionsHtml = headers.map(h => `<option value="${h}">${h}</option>`).join('');

            campos.forEach(c => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                <div class="input-group input-group-sm">
                    <span class="input-group-text w-25 bg-light text-muted justify-content-end">${c.l}</span>
                    <select class="form-select select-mapeo-fuente" data-campo="${c.k}">
                        <option value="">-- Ignorar --</option>
                        ${optionsHtml}
                    </select>
                </div>`;
                grid.appendChild(col);
            });
        }

        const btnCrear = document.getElementById("btnCrearFuente");
        if (btnCrear) {
            btnCrear.addEventListener("click", (e) => {
                e.preventDefault();
                const form = document.getElementById("formCrearFuente");

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Lógica de mapeo: SOLO si es CSV
                const tipo = document.getElementById('selectorTipoFuente').value;
                const inputJsonMapeo = document.getElementById('jsonMapeo');
                inputJsonMapeo.value = ""; // Limpiar siempre por defecto

                if (tipo === 'ESTATICA_CSV') {
                    const map = {};
                    let hayMapeo = false;
                    document.querySelectorAll('.select-mapeo-fuente').forEach(s => {
                        if (s.value && s.value.trim() !== "") {
                            map[s.dataset.campo] = [s.value];
                            hayMapeo = true;
                        }
                    });
                    if (hayMapeo) {
                        inputJsonMapeo.value = JSON.stringify(map);
                    }
                }
                // Si es JSON, inputJsonMapeo queda vacío, activando el mapeo default del backend

                const modal = new bootstrap.Modal(document.getElementById("modalExitoFuente"));
                modal.show();

                setTimeout(() => {
                    form.submit();
                }, 800);
            });
        }
    </script>
{{/partial}}
{{> templates/layout}}