<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMapa</title>

    <link rel="icon" href="/metamapa-icon.png" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Ajustes personalizados */
        body, html { height: 100%; overflow: hidden; } /* Evita doble scroll */

        #map-container {
            height: calc(100vh - 56px); /* 100% menos la altura del Navbar */
            width: 100%;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark bg-dark px-3 py-2 position-relative w-100">

    <div class="navbar-nav">
        <a href="/hechos/nuevo"
           class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
            <i class="fa-solid fa-plus"></i>
            <span class="d-none d-sm-block">Nuevo Hecho</span>
        </a>
    </div>

    <a class="navbar-brand position-absolute top-50 start-50 translate-middle d-flex align-items-center"
       href="/">
        <img src="/metamapa-icon.png"
             alt="Logo"
             class="d-inline-block align-text-top"
             style="height: 40px; width: auto;">
    </a>

    <div class="ms-auto d-flex gap-2">
        <a href="/auth/register" class="btn btn-primary btn-sm fw-bold">
            Registrarse
        </a>

        <a href="/auth/login" class="btn btn-primary btn-sm d-flex align-items-center gap-2">
            <i class="fa-solid fa-user"></i>
            <span>Ingresar</span>
        </a>
    </div>

</nav>

<div class="container-fluid p-0">
    <div id="map-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const hechosData = {{{hechosJson}}};

            const map = L.map('map-container').setView([-34.6037, -58.3816], 12);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            hechosData.forEach(hecho => {
                const ubicacion = hecho.hecho_ubicacion; // o hecho.ubicacion si ya arreglaste el getter

                if (ubicacion && ubicacion.latitud && ubicacion.longitud) {
                    let fechaTexto = "S/D";
                    let horaTexto = "";

                    if (hecho.hecho_fecha_suceso) {
                        // 1. Convertir el String ISO a Objeto Date
                        const fechaObj = new Date(hecho.hecho_fecha_suceso);

                        // 2. Formatear la FECHA (DD/MM/AAAA)
                        // 'es-AR' asegura el formato día/mes/año
                        fechaTexto = fechaObj.toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });

                        // 3. Formatear la HORA (HH:MM)
                        horaTexto = fechaObj.toLocaleTimeString('es-AR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    // Lógica de imagen (con clases Bootstrap)
                    let htmlImagen = '';
                    // Verifica el nombre de la propiedad según tu log (hecho.fotos o hecho.hecho_fotos)
                    const fotos = hecho.fotos || hecho.hecho_fotos;

                    if (fotos && fotos.length > 0) {
                        htmlImagen = `
                            <img src="/hechos/${hecho.id}/fotos/0"
                                 class="card-img-top mb-2"
                                 alt="Foto"
                                 style="height: 140px; object-fit: cover;">
                        `;
                    }

                    // 4. POPUP ESTILIZADO CON BOOTSTRAP CARDS
                    // Usamos clases como 'card', 'card-body', 'badge', 'text-muted'
                    const popupHTML = `
                        <div class="card border-0" style="width: 200px;">
                            ${htmlImagen}
                            <div class="card-body p-0">
                                <h6 class="card-title mb-1">${hecho.hecho_titulo}</h6>

                                <h6 class="card-text small text-muted mb-1" style="line-height: 1.2;">
                                    ${hecho.hecho_descripcion || ''}
                                </h6>

                                <h4 class="card-text small text-muted mb-1" style="line-height: 1.2;">
                                    <i class="fa-solid fa-location-dot me-1"></i>
                                    ${hecho.hecho_direccion || 'Sin detallar'}
                                </h4>

                                <div class="text-muted small mb-2">
                                    <i class="fa-regular fa-calendar me-1"></i> ${fechaTexto}
                                    <span class="mx-1">|</span>
                                    <i class="fa-regular fa-clock me-1"></i> ${horaTexto}
                                </div>

                                <span class="badge bg-primary mb-2">
                                    ${hecho.hecho_categoria || 'General'}
                                </span>

                            </div>
                        </div>
                    `;

                    L.marker([ubicacion.latitud, ubicacion.longitud])
                        .addTo(map)
                        .bindPopup(popupHTML);
                }
            });
        });
</script>
</body>
</html>