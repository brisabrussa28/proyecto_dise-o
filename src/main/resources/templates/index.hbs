{{#partial "contenido"}}
    <div id="map-container" style="height: 100%; width: 100%; position: relative;">

        <div class="search-controls-overlay">
            <div class="d-flex gap-2">
                <button class="btn btn-warning" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasFiltros" aria-controls="offcanvasFiltros">
                    <i class="bi bi-list"></i>
                </button>
                <input class="form-control mr-sm-2 shadow-sm" type="search" placeholder="Buscar un hecho" id="searchInput"
                       aria-label="Search"
                       style="width: 37vw;">
            </div>
        </div>

        <!-- El mapa real se inicializará aquí -->
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasResultados"
         aria-labelledby="offcanvasResultadosLabel"
         data-bs-backdrop="false"
         data-bs-scroll="true">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasResultadosLabel">Resultados de Búsqueda</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex flex-column" style="gap: 3vh;">
                {{#each hechos}}
                    <div class="d-flex flex-row hechos-resultantes shadow">
                        {{titulo}}
                        <button type="button" class="btn btn-primary ver-en-mapa"
                                data-latitud="{{ubicacion.latitud}}"
                                data-longitud="{{ubicacion.longitud}}"
                                data-titulo="{{titulo}}">Ver en el mapa</button>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const hechosData = {{{hechosJson}}};
            const currentUserId = {{#if usuario_id}}{{usuario_id}}{{else}}-1{{/if}};

            const map = L.map('map').setView([-34.6037, -58.3816], 12);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

            hechosData.forEach(hecho => {
                const ubicacion = hecho.hecho_ubicacion;
                const direccion = hecho.hecho_direccion ? hecho.hecho_direccion.trim() : 'Ubicación aproximada';
                const provincia = hecho.hecho_provincia ? hecho.hecho_provincia.trim() : '';

                const ubicacionTexto = provincia ? `${direccion}, ${provincia}` : direccion;

                if (ubicacion && ubicacion.latitud && ubicacion.longitud) {
                    let fechaTexto = "S/D";
                    let horaTexto = "";

                    if (hecho.hecho_fecha_suceso) {
                        const fechaObj = new Date(hecho.hecho_fecha_suceso);
                        fechaTexto = fechaObj.toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        horaTexto = fechaObj.toLocaleTimeString('es-AR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }

                    let htmlImagen = '';
                    const fotos = hecho.fotos || hecho.hecho_fotos;
                    if (fotos && fotos.length > 0) {
                        htmlImagen = `
                        <img src="/hechos/${hecho.id}/fotos/0"
                             class="card-img-top mb-2"
                             alt="Foto"
                             style="height: 140px; object-fit: scale-down;">
                    `;
                    }

                    // Construir HTML del autor
                    const autor = hecho.autor || hecho.hecho_autor || {};
                    const autorNombre = autor.userName || 'Dataset';
                    const autorId = autor.id || autor.autor_id;
                    let iconoHTML = '';

                    if (autor.foto) {
                        iconoHTML = `<img src="${autor.foto}" class="rounded-circle me-1" width="20" height="20">`;
                    } else {
                        iconoHTML = `<i class="fa-solid fa-user me-1"></i>`;
                    }


                    if (autorNombre === 'Dataset'){
                        autorHTML = `
                            <span class="text-secondary fw-bold d-flex align-items-center"
                                  style="cursor: default;">
                               ${iconoHTML}
                               <span>${autorNombre}</span>
                            </span>
                        `;
                    } else {
                        autorHTML = `
                            <a href="/perfiles/${autorNombre}"
                                class="text-decoration-none text-secondary fw-bold d-flex align-items-center"
                                title="Ver perfil"
                                style"cursor: pointer;">
                                ${iconoHTML}
                                <span>${autorNombre}</span>
                            </a>
                        `;
                    }

                    // Botón de edición (solo si es el autor)
                    let editButton = '';
                    if (autorId && autorId === currentUserId) {
                        const fechaCarga = new Date(hecho.hecho_fecha_carga);
                        const ahora = new Date();
                        const unaSemanaEnMs = 7 * 24 * 60 * 60 * 1000; // 7 días en milisegundos
                        const diferencia = ahora - fechaCarga;

                        if(diferencia <= unaSemanaEnMs) {
                            editButton = `
                            <a href="/hechos/${hecho.id}/editar"
                               class="btn btn-outline-secondary btn-sm border-0"
                               title="Editar mi hecho" style="padding: 0">
                                <i class="fa-solid fa-pen"></i>
                            </a>
                            `;
                        }
                    }


                    // Botón de reportar (todos salvo el autor)
                    let reportButton = '';
                    if (autorId && autorId !== currentUserId) {
                        reportButton = `
                        <a href="/hechos/reporte/${hecho.id}"
                            class="btn btn-danger"
                            title="Reporta hecho" style="padding-left: 5px; padding-right: 5px; padding-top: 1px; padding-bottom: 1px; color: white;">
                            Reportar
                        </a>
                            `;
                    }

                    const popupHTML = `
                        <div class="card border-0" style="width: 220px; overflow: hidden;">

                            <div class="position-relative border-bottom pb-2">
                                ${htmlImagen ? `
                                    <div class="mb-2" style="margin: -1px -1px 0 -1px;"> ${htmlImagen}
                                    </div>
                                ` : ''}

                                <div class="px-2 pt-1">
                                    <h6 class="card-title fw-bold mb-1 text-truncate" title="${hecho.hecho_titulo}">
                                        <a href="/hechos/${hecho.id}" class="text-decoration-none text-dark stretched-link">
                                            ${hecho.hecho_titulo}
                                        </a>
                                    </h6>
                                    <p class="card-text small text-secondary mb-1"
                                       style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">
                                        ${hecho.hecho_descripcion || 'Sin descripción disponible.'}
                                    </p>
                                </div>
                            </div>

                            <div class="px-2 py-2 border-bottom bg-light bg-opacity-25">

                                <div class="d-flex align-items-start mb-1 text-muted small">
                                    <i class="fa-solid fa-location-dot mt-1 me-2 text-danger"></i>
                                    <span style="line-height: 1.2;">
                                        ${ubicacionTexto}
                                    </span>
                                </div>

                                <div class="d-flex align-items-center mb-2 text-muted small">
                                    <i class="fa-regular fa-calendar me-2 text-primary"></i>
                                    <span>${fechaTexto}</span>
                                    ${horaTexto ? `<span class="mx-1 text-secondary">|</span> <i class="fa-regular fa-clock me-1"></i> ${horaTexto}` : ''}
                                </div>

                                <div>
                                    <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">
                                        ${hecho.hecho_categoria || 'General'}
                                    </span>
                                </div>
                            </div>

                            <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center px-2 py-2">

                                <div class="small text-truncate" style="max-width: 140px;">
                                    ${autorHTML}
                                </div>

                                ${editButton ? `
                                    <div class="ms-2">
                                        ${editButton} </div>
                                ` : ''}
                                ${reportButton ? `
                                    <div class="ms-2">
                                        ${reportButton} </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    L.marker([ubicacion.latitud, ubicacion.longitud])
                            .addTo(map)
                            .bindPopup(popupHTML);
                }
            });
            function centrarMapaEnHecho(lat, lng, titulo) {

                if (typeof L !== 'undefined' && map) {
                    map.setView([lat, lng], 15);
                }

                const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance('#offcanvasResultados');
                bsOffcanvas.hide();
            }

                document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('ver-en-mapa')) {
                    const button = e.target;
                    const latitud = button.getAttribute('data-latitud');
                    const longitud = button.getAttribute('data-longitud');
                    const titulo = button.getAttribute('data-titulo');

                    if (latitud && longitud) {
                        centrarMapaEnHecho(parseFloat(latitud), parseFloat(longitud), titulo);
                    }
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // 1. Obtén referencia al input de búsqueda por su nuevo ID
            const searchInput = document.getElementById('searchInput');

            // 2. Obtén la instancia del Offcanvas de Bootstrap
            // Requerimos la clase nativa de Bootstrap JS para controlar el offcanvas programáticamente
            const offcanvasResultadosEl = document.getElementById('offcanvasResultados');
            const offcanvasResultados = new bootstrap.Offcanvas(offcanvasResultadosEl);

            // 3. Añade el Event Listener para la tecla "Enter"
            searchInput.addEventListener('keydown', function(e) {
                // Verifica si la tecla presionada es "Enter"
                if (e.key === 'Enter' || e.keyCode === 13) {
                    const query = searchInput.value.trim();

                    if (query !== "") {
                        // Muestra la barra lateral de resultados
                        offcanvasResultados.show();

                        // *** AQUÍ LLAMARÍAS A TU FUNCIÓN DE BACKEND/API PARA BUSCAR LOS HECHOS ***
                        console.log("Iniciando búsqueda de: " + query);
                        // cargarResultadosEnSidebar(query);
                    } else {
                        // Si el campo está vacío, puedes ocultar la barra si estaba abierta
                        offcanvasResultados.hide();
                    }
                }
            });
        });
    </script>

{{/partial}}
{{> templates/layout}}