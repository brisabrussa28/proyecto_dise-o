{{#partial "contenido"}}
    <div id="map-container" style="height: 100%; width: 100%; position: relative;">

        <div class="search-controls-overlay">
            <div class="d-flex gap-2">
                <button class="btn btn-warning" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasFiltros" aria-controls="offcanvasFiltros">
                    Filtros
                    <i class="bi bi-list"></i>
                </button>
                <input class="form-control mr-sm-2 shadow-sm" type="search" placeholder="Search"
                       aria-label="Search"
                       style="width: 37vw;">
            </div>
        </div>

        <!-- El mapa real se inicializará aquí -->
        <div id="map" style="height: 100%; width: 100%;"></div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const hechosData = {{{hechosJson}}};
            const currentUserId = {{#if usuario_id}}{{usuario_id}}{{else}}-1{{/if}};

            const map = L.map('map').setView([-34.6037, -58.3816], 12);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

            hechosData.forEach(hecho => {
                const ubicacion = hecho.hecho_ubicacion;

                if (ubicacion && ubicacion.latitud && ubicacion.longitud) {
                    let fechaTexto = "S/D";
                    let horaTexto = "";

                    if (hecho.hecho_fecha_suceso) {
                        const fechaObj = new Date(hecho.hecho_fecha_suceso);
                        fechaTexto = fechaObj.toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        horaTexto = fechaObj.toLocaleTimeString('es-AR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }

                    let htmlImagen = '';
                    const fotos = hecho.fotos || hecho.hecho_fotos;
                    if (fotos && fotos.length > 0) {
                        htmlImagen = `
                        <img src="/hechos/${hecho.id}/fotos/0"
                             class="card-img-top mb-2"
                             alt="Foto"
                             style="height: 140px; object-fit: cover;">
                    `;
                    }

                    // Construir HTML del autor
                    const autor = hecho.autor || hecho.hecho_autor || {};
                    const autorNombre = autor.userName || 'Dataset';
                    const autorId = autor.id || autor.autor_id;
                    let iconoHTML = '';

                    if (autor.foto) {
                        iconoHTML = `<img src="${autor.foto}" class="rounded-circle me-1" width="20" height="20">`;
                    } else {
                        iconoHTML = `<i class="fa-solid fa-user me-1"></i>`;
                    }


                    if (autorNombre === 'Dataset'){
                        autorHTML = `
                            <span class="text-secondary fw-bold d-flex align-items-center"
                                  style="cursor: default;">
                               ${iconoHTML}
                               <span>${autorNombre}</span>
                            </span>
                        `;
                    } else {
                        autorHTML = `
                            <a href="/perfil/${autorNombre}"
                                class="text-decoration-none text-secondary fw-bold d-flex align-items-center"
                                title="Ver perfil"
                                style"cursor: pointer;">
                                ${iconoHTML}
                                <span>${autorNombre}</span>
                            </a>
                        `;
                    }

                    // Botón de edición (solo si es el autor)
                    let editButton = '';
                    if (autorId && autorId === currentUserId) {
                        const fechaCarga = new Date(hecho.hecho_fecha_carga);
                        const ahora = new Date();
                        const unaSemanaEnMs = 7 * 24 * 60 * 60 * 1000; // 7 días en milisegundos
                        const diferencia = ahora - fechaCarga;

                        if(diferencia <= unaSemanaEnMs) {
                            editButton = `
                            <a href="/hechos/${hecho.id}/editar"
                               class="btn btn-outline-secondary btn-sm border-0"
                               title="Editar mi hecho" style="padding: 0">
                                <i class="fa-solid fa-pen"></i>
                            </a>
                            `;
                        }
                    }

                    const popupHTML = `
                    <div class="card border-0" style="width: 200px;">
                        ${htmlImagen}
                        <div class="card-body p-0">
                            <h6 class="card-title mb-1">${hecho.hecho_titulo}</h6>
                            <h6 class="card-text small text-muted mb-1" style="line-height: 1.2;">
                                ${hecho.hecho_descripcion || ''}
                            </h6>
                            <h4 class="card-text small text-muted mb-1" style="line-height: 1.2;">
                                <i class="fa-solid fa-location-dot me-1"></i>
                                ${hecho.hecho_direccion ? hecho.hecho_direccion + ', ' : ''}${hecho.hecho_provincia || ''}
                            </h4>
                            <div class="text-muted small mb-2">
                                <i class="fa-regular fa-calendar me-1"></i> ${fechaTexto}
                                <span class="mx-1">|</span>
                                <i class="fa-regular fa-clock me-1"></i> ${horaTexto}
                            </div>
                            <span class="badge bg-primary mb-2">
                                ${hecho.hecho_categoria || 'Sin categoria'}
                            </span>
                        </div>
                        <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center" style="padding: 0">
                            <medium class="text-muted">
                                ${autorHTML}
                            </medium>
                            ${editButton}
                        </div>
                    </div>
                `;

                    L.marker([ubicacion.latitud, ubicacion.longitud])
                            .addTo(map)
                            .bindPopup(popupHTML);
                }
            });
        });
    </script>

{{/partial}}
{{> templates/layout}}