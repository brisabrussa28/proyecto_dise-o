{{#partial "contenido"}}
    <style>
        #map-container {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .search-controls-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            width: 700px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-controls-overlay .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .search-controls-overlay .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-controls-overlay .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
        }

        .search-controls-overlay .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }

        .search-controls-overlay .btn-outline-light {
            border-color: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 0.9);
        }

        .search-controls-overlay .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
            color: white;
        }

        #contadorHechos {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #filtrosAplicados {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid rgba(40, 167, 69, 0.5);
            border-radius: 5px;
            padding: 8px 12px;
            margin-top: 10px;
        }

        .ver-en-mapa {
            transition: all 0.2s;
        }

        .ver-en-mapa:hover {
            transform: scale(1.05);
            background-color: #0d6efd !important;
            color: white !important;
        }

        .offcanvas-start {
            width: 450px !important;
        }

        .hecho-card {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .hecho-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .hecho-card.consensuado {
            border-left-color: #28a745;
        }
    </style>

    <div id="map-container">
        <div class="search-controls-overlay">
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-warning" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasFiltros" aria-controls="offcanvasFiltros">
                    <i class="bi bi-funnel me-1"></i> Filtros
                </button>

                <input class="form-control shadow-sm" type="search"
                       placeholder="Buscar hecho por título..." id="searchInput"
                       aria-label="Search" style="flex: 1; min-width: 200px;">

                <div class="form-check form-switch ms-2" style="min-width: 150px;">
                    <input class="form-check-input" type="checkbox"
                           id="filtroConsensuados" style="cursor: pointer;">
                    <label class="form-check-label text-white small"
                           for="filtroConsensuados" style="white-space: nowrap;">
                        <i class="fa-solid fa-check-circle me-1"></i> Solo consensuados
                    </label>
                </div>

                <button class="btn btn-primary btn-sm" type="button" id="btnBuscarRapido">
                    <i class="fa-solid fa-search me-1"></i> Buscar
                </button>

                <button class="btn btn-outline-light btn-sm" type="button" id="btnLimpiarBusqueda">
                    <i class="fa-solid fa-times me-1"></i> Limpiar
                </button>
            </div>

            <div id="filtrosAplicados" class="mt-2 text-white small" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fa-solid fa-filter me-1"></i>
                        <span id="filtrosTexto"></span>
                    </div>
                    <button class="btn btn-sm btn-outline-light py-0 px-2" onclick="limpiarBusqueda()">
                        <i class="fa-solid fa-times fa-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="map" style="height: 100%; width: 100%;"></div>

        <div id="contadorHechos">
            <i class="fa-solid fa-map-marker-alt me-1"></i>
            <span id="contadorNumero">0</span> hechos mostrados
        </div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasResultados"
         aria-labelledby="offcanvasResultadosLabel"
         data-bs-backdrop="false"
         data-bs-scroll="true">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title" id="offcanvasResultadosLabel">
                <i class="fa-solid fa-search me-2"></i> Resultados de Búsqueda
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0" id="resultadosBody">
            <div class="text-center py-5 text-muted">
                <i class="fa-solid fa-search fa-2x mb-3"></i><br>
                Ingrese un término de búsqueda o aplique filtros
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let map;
            let markers = [];
            const currentUserId = {{#if usuario_id}}{{usuario_id}}{{else}}-1{{/if}};

            // Estado de los filtros
            let filtrosActivos = {
                titulo: '',
                soloConsensuados: false,
                categoria: '0',
                fuente: '0',
                coleccion: '0',
                fechaDesde: '',
                fechaHasta: ''
            };

            function initMap() {
                map = L.map('map').setView([-34.6037, -58.3816], 12);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
            }

            function clearMarkers() {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                updateContador(0);
            }

            function updateContador(cantidad) {
                document.getElementById('contadorNumero').textContent = cantidad;
            }

            function addMarker(hecho) {
                const ubicacion = hecho.hecho_ubicacion;
                if (!ubicacion || !ubicacion.latitud || !ubicacion.longitud) return null;

                const direccion = hecho.hecho_direccion ? hecho.hecho_direccion.trim() : 'Ubicación aproximada';
                const provincia = hecho.hecho_provincia ? hecho.hecho_provincia.trim() : '';
                const ubicacionTexto = provincia ? `${direccion}, ${provincia}` : direccion;

                let fechaTexto = "Fecha no disponible";
                let horaTexto = "";

                if (hecho.hecho_fecha_suceso) {
                    try {
                        const fechaObj = new Date(hecho.hecho_fecha_suceso);
                        fechaTexto = fechaObj.toLocaleDateString('es-AR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        horaTexto = fechaObj.toLocaleTimeString('es-AR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        console.warn('Error parsing date:', hecho.hecho_fecha_suceso);
                    }
                }

                    let htmlImagen = '';
                    const fotos = hecho.fotos || hecho.hecho_fotos;
                    if (fotos && fotos.length > 0) {
                        if (fotos[0].esVideo){
                            htmlImagen = `
                                <div class="d-flex align-items-center justify-content-center bg-black mb-2" style="height: 140px;">
                                     <a href="/hechos/${hecho.id}"><video src="/hechos/${hecho.id}/multimedia/0"
                                     class="w-100 h-100"
                                     muted
                                     autoplay
                                     loop
                                     style="object-fit: contain;">
                                     </video></a>
                                 </div>
                             `;
                        } else {
                            htmlImagen = `
                            <a href="/hechos/${hecho.id}"><img src="/hechos/${hecho.id}/multimedia/0"
                             class="card-img-top mb-2"
                             alt="Foto"
                             style="height: 140px; object-fit: fit;"></a>
                            `;
                        }
                    }

                const autor = hecho.autor || hecho.hecho_autor || {};
                const autorNombre = autor.userName || 'Dataset';
                const autorId = autor.id || autor.autor_id;

                let autorHTML = '';
                if (autorNombre === 'Dataset'){
                    autorHTML = `
                        <span class="text-secondary fw-bold d-flex align-items-center">
                           <i class="fa-solid fa-database me-1"></i>
                           <span>${autorNombre}</span>
                        </span>
                    `;
                } else {
                    autorHTML = `
                        <a href="/perfiles/${autorNombre}"
                            class="text-decoration-none text-secondary fw-bold d-flex align-items-center"
                            title="Ver perfil">
                            <i class="fa-solid fa-user me-1"></i>
                            <span>${autorNombre}</span>
                        </a>
                    `;
                }

                let editButton = '';
                if (autorId && autorId === currentUserId) {
                    const fechaCarga = new Date(hecho.hecho_fecha_carga);
                    const ahora = new Date();
                    const unaSemanaEnMs = 7 * 24 * 60 * 60 * 1000;
                    const diferencia = ahora - fechaCarga;

                    if(diferencia <= unaSemanaEnMs) {
                        editButton = `
                        <a href="/hechos/${hecho.id}/editar"
                           class="btn btn-outline-secondary btn-sm"
                           title="Editar mi hecho">
                            <i class="fa-solid fa-pen"></i> Editar
                        </a>
                        `;
                    }
                }

                let reportButton = '';
                if (autorId && autorId !== currentUserId) {
                    reportButton = `
                    <a href="/hechos/reporte/${hecho.id}"
                        class="btn btn-danger btn-sm text-white"
                        title="Reportar hecho">
                        <i class="fa-solid fa-flag me-1"></i> Reportar
                    </a>
                    `;
                }

                const esConsensuado = hecho.colecciones && hecho.colecciones.length > 0;
                const badgeConsensuado = esConsensuado ?
                    '<span class="badge bg-success ms-2"><i class="fa-solid fa-check me-1"></i>Consensuado</span>' : '';

                const popupHTML = `
                    <div class="card" style="width: 280px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div class="card-body p-3">
                                ${htmlImagen ? `
                                    <div class="mb-2" style="margin: -1px -1px 0 -1px;"> ${htmlImagen}
                                    </div>
                                ` : ''}

                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <a href="/hechos/${hecho.id}" class="text-decoration-none text-black"><h6 class="card-title fw-bold mb-0" style="font-size: 0.95rem;">
                                    ${hecho.hecho_titulo}
                                </h6></a>
                                ${badgeConsensuado}
                            </div>

                            <p class="card-text text-muted small mb-2" style="font-size: 0.85rem;">
                                ${hecho.hecho_descripcion || 'Sin descripción disponible.'}
                            </p>

                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">
                                    ${hecho.hecho_categoria || 'General'}
                                </span>
                            </div>

                            <div class="small text-muted mb-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fa-solid fa-location-dot me-2 text-danger" style="width: 16px;"></i>
                                    <span>${ubicacionTexto}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="fa-regular fa-calendar me-2 text-primary" style="width: 16px;"></i>
                                    <span>${fechaTexto} ${horaTexto ? '• ' + horaTexto : ''}</span>
                                </div>
                            </div>

                            <div class="border-top pt-2 mt-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        ${autorHTML}
                                    </div>
                                    <div class="d-flex gap-1">
                                        ${editButton}
                                        ${reportButton}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const marker = L.marker([ubicacion.latitud, ubicacion.longitud], {
                    title: hecho.hecho_titulo
                }).addTo(map)
                .bindPopup(popupHTML);

                markers.push(marker);
                return marker;
            }

            function mostrarHechosEnMapa(hechos) {
                clearMarkers();

                if (!hechos || hechos.length === 0) {
                    updateContador(0);
                    return;
                }

                const markersValidos = [];

                hechos.forEach(hecho => {
                    const marker = addMarker(hecho);
                    if (marker) {
                        markersValidos.push(marker);
                    }
                });

                markers = markersValidos;
                updateContador(markers.length);

                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            async function buscarHechos() {
                const searchInput = document.getElementById('searchInput');
                const filtroConsensuados = document.getElementById('filtroConsensuados');
                const resultadosBody = document.getElementById('resultadosBody');
                const offcanvasResultadosEl = document.getElementById('offcanvasResultados');
                const offcanvasResultados = bootstrap.Offcanvas.getOrCreateInstance(offcanvasResultadosEl);

                const titulo = searchInput.value.trim();
                const soloConsensuados = filtroConsensuados.checked;

                // Actualizar filtros activos
                filtrosActivos.titulo = titulo;
                filtrosActivos.soloConsensuados = soloConsensuados;

                // Determinar qué endpoint usar
                const usarBusquedaRapida = titulo || soloConsensuados;

                if (!usarBusquedaRapida) {
                    mostrarTodosLosHechos();
                    if (offcanvasResultados._isShown) {
                        offcanvasResultados.hide();
                    }
                    return;
                }

                resultadosBody.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Buscando hechos...</p>
                    </div>
                `;

                offcanvasResultados.show();

                try {
                    let url;
                    if (titulo || soloConsensuados) {
                        // Usar búsqueda rápida si solo tenemos título y/o consensuados
                        url = `/api/hechos/buscar-rapido?titulo=${encodeURIComponent(titulo)}&soloConsensuados=${soloConsensuados}`;
                    } else {
                        // Usar búsqueda completa si hay otros filtros
                        url = construirUrlFiltrosCompletos();
                    }

                    console.log('Fetching URL:', url);

                    const resp = await fetch(url);

                    if (!resp.ok) {
                        const errorData = await resp.json().catch(() => ({}));
                        throw new Error(errorData.mensaje || `Error ${resp.status}: ${resp.statusText}`);
                    }

                    const data = await resp.json();
                    const hechosResultantes = Array.isArray(data) ? data : (data.resultados || []);

                    mostrarResultadosBusqueda(hechosResultantes, titulo, soloConsensuados);
                    mostrarHechosEnMapa(hechosResultantes);
                    actualizarFiltrosTexto();

                } catch (error) {
                    console.error('Error en búsqueda:', error);
                    resultadosBody.innerHTML = `
                        <div class="alert alert-danger m-3" role="alert">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            <strong>Error en la búsqueda:</strong><br>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }

            function construirUrlFiltrosCompletos() {
                const params = new URLSearchParams();

                if (filtrosActivos.titulo) params.append('titulo', filtrosActivos.titulo);
                if (filtrosActivos.categoria !== "0") params.append('categoria', filtrosActivos.categoria);
                if (filtrosActivos.fuente !== "0") params.append('fuente', filtrosActivos.fuente);
                if (filtrosActivos.coleccion !== "0") params.append('coleccion', filtrosActivos.coleccion);
                if (filtrosActivos.fechaDesde) params.append('fechaDesde', filtrosActivos.fechaDesde);
                if (filtrosActivos.fechaHasta) params.append('fechaHasta', filtrosActivos.fechaHasta);
                if (filtrosActivos.soloConsensuados) params.append('soloConsensuados', 'true');

                return `/api/hechos/buscar-completo?${params.toString()}`;
            }

            function mostrarResultadosBusqueda(hechos, titulo, soloConsensuados) {
                const resultadosBody = document.getElementById('resultadosBody');
                resultadosBody.innerHTML = '';

                if (!hechos || hechos.length === 0) {
                    const filtrosTexto = [];
                    if (titulo) filtrosTexto.push(`"${titulo}"`);
                    if (soloConsensuados) filtrosTexto.push('solo consensuados');

                    resultadosBody.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="fa-solid fa-search fa-2x mb-3"></i><br>
                            No se encontraron hechos
                            ${filtrosTexto.length > 0 ? `con ${filtrosTexto.join(' y ')}` : ''}
                        </div>
                    `;
                    return;
                }

                const filtrosTexto = [];
                if (titulo) filtrosTexto.push(`Título: "${titulo}"`);
                if (soloConsensuados) filtrosTexto.push('Solo consensuados');

                const resumenHTML = `
                    <div class="p-3 bg-light border-bottom sticky-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fa-solid fa-filter me-2"></i>
                                    ${hechos.length} resultado${hechos.length !== 1 ? 's' : ''}
                                </h6>
                                <small class="text-muted">
                                    ${filtrosTexto.join(' • ')}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="limpiarBusqueda()">
                                <i class="fa-solid fa-times me-1"></i> Limpiar
                            </button>
                        </div>
                    </div>
                `;
                resultadosBody.innerHTML = resumenHTML;

                const resultadosContainer = document.createElement('div');
                resultadosContainer.className = 'p-2';

                hechos.forEach((hecho, index) => {
                    const esConsensuado = hecho.colecciones && hecho.colecciones.length > 0;
                    const fecha = hecho.hecho_fecha_suceso ?
                        new Date(hecho.hecho_fecha_suceso).toLocaleDateString('es-AR') : 'S/F';

                    const resultadoHTML = `
                        <div class="card mb-2 hecho-card ${esConsensuado ? 'consensuado' : ''}"
                             style="border: 1px solid #dee2e6; border-radius: 8px;">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-grow-1 me-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <h6 class="card-title mb-0 me-2" style="font-size: 0.95rem;">
                                                ${hecho.hecho_titulo}
                                            </h6>
                                            ${esConsensuado ?
                                                '<span class="badge bg-success" title="Hecho consensuado"><i class="fa-solid fa-check"></i></span>' :
                                                ''}
                                        </div>
                                        <p class="card-text text-muted small mb-2" style="font-size: 0.85rem;">
                                            ${hecho.hecho_descripcion || 'Sin descripción'}
                                        </p>
                                        <div class="d-flex flex-wrap gap-2 small align-items-center">
                                            <span class="badge bg-info text-dark">
                                                ${hecho.hecho_categoria || 'General'}
                                            </span>
                                            <span class="text-muted">
                                                <i class="fa-solid fa-calendar-day me-1"></i>${fecha}
                                            </span>
                                            <span class="text-muted">
                                                <i class="fa-solid fa-location-dot me-1"></i>${hecho.hecho_provincia || 'S/D'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column gap-1">
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm ver-en-mapa"
                                                data-latitud="${hecho.hecho_ubicacion?.latitud || '-34.6037'}"
                                                data-longitud="${hecho.hecho_ubicacion?.longitud || '-58.3816'}"
                                                data-titulo="${hecho.hecho_titulo}"
                                                title="Ver en mapa">
                                            <i class="fa-solid fa-map-marker-alt"></i>
                                        </button>
                                        <a href="/hechos/${hecho.id}"
                                           class="btn btn-outline-secondary btn-sm"
                                           title="Ver detalles">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    resultadosContainer.insertAdjacentHTML('beforeend', resultadoHTML);
                });

                resultadosBody.appendChild(resultadosContainer);
            }

            function mostrarTodosLosHechos() {
                const hechosData = {{{hechosJson}}};
                mostrarHechosEnMapa(hechosData);
                resetearFiltrosUI();
                actualizarFiltrosTexto();
            }

            function resetearFiltrosUI() {
                filtrosActivos = {
                    titulo: '',
                    soloConsensuados: false,
                    categoria: '0',
                    fuente: '0',
                    coleccion: '0',
                    fechaDesde: '',
                    fechaHasta: ''
                };

                document.getElementById('searchInput').value = '';
                document.getElementById('filtroConsensuados').checked = false;
                document.getElementById('filtrosAplicados').style.display = 'none';

                // También resetear los filtros del sidebar si existen
                if (document.getElementById('Categoria')) document.getElementById('Categoria').value = "0";
                if (document.getElementById('Fuente')) document.getElementById('Fuente').value = "0";
                if (document.getElementById('Coleccion')) document.getElementById('Coleccion').value = "0";
                if (document.getElementById('fechaDesde')) document.getElementById('fechaDesde').value = "";
                if (document.getElementById('fechaHasta')) document.getElementById('fechaHasta').value = "";
                if (document.getElementById('filtroConsensuadosSidebar')) {
                    document.getElementById('filtroConsensuadosSidebar').checked = false;
                }
            }

            function actualizarFiltrosTexto() {
                const filtrosAplicadosDiv = document.getElementById('filtrosAplicados');
                const filtrosTextoSpan = document.getElementById('filtrosTexto');

                const filtros = [];

                if (filtrosActivos.titulo) filtros.push(`"${filtrosActivos.titulo}"`);
                if (filtrosActivos.soloConsensuados) filtros.push('Consensuados');
                if (filtrosActivos.categoria !== "0") filtros.push(`Categoría: ${filtrosActivos.categoria}`);
                if (filtrosActivos.fuente !== "0") filtros.push(`Fuente: ${filtrosActivos.fuente}`);
                if (filtrosActivos.coleccion !== "0") filtros.push(`Colección: ${filtrosActivos.coleccion}`);
                if (filtrosActivos.fechaDesde) filtros.push(`Desde: ${filtrosActivos.fechaDesde}`);
                if (filtrosActivos.fechaHasta) filtros.push(`Hasta: ${filtrosActivos.fechaHasta}`);

                if (filtros.length > 0) {
                    filtrosTextoSpan.textContent = filtros.join(' • ');
                    filtrosAplicadosDiv.style.display = 'block';
                } else {
                    filtrosAplicadosDiv.style.display = 'none';
                }
            }

            function limpiarBusqueda() {
                resetearFiltrosUI();
                mostrarTodosLosHechos();

                const resultadosBody = document.getElementById('resultadosBody');
                resultadosBody.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fa-solid fa-search fa-2x mb-3"></i><br>
                        Ingrese un término de búsqueda o aplique filtros
                    </div>
                `;

                const offcanvasResultados = bootstrap.Offcanvas.getInstance('#offcanvasResultados');
                if (offcanvasResultados) {
                    offcanvasResultados.hide();
                }
            }

            async function aplicarFiltrosAvanzados() {
                const categoriaSelect = document.getElementById('Categoria');
                const fuenteSelect = document.getElementById('Fuente');
                const coleccionSelect = document.getElementById('Coleccion');
                const fechaDesdeInput = document.getElementById('fechaDesde');
                const fechaHastaInput = document.getElementById('fechaHasta');
                const filtroConsensuadosSidebar = document.getElementById('filtroConsensuadosSidebar');
                const resultadosBody = document.getElementById('resultadosBody');
                const offcanvasResultadosEl = document.getElementById('offcanvasResultados');
                const offcanvasResultados = bootstrap.Offcanvas.getOrCreateInstance(offcanvasResultadosEl);

                // Actualizar filtros activos
                filtrosActivos.categoria = categoriaSelect ? categoriaSelect.value : '0';
                filtrosActivos.fuente = fuenteSelect ? fuenteSelect.value : '0';
                filtrosActivos.coleccion = coleccionSelect ? coleccionSelect.value : '0';
                filtrosActivos.fechaDesde = fechaDesdeInput ? fechaDesdeInput.value : '';
                filtrosActivos.fechaHasta = fechaHastaInput ? fechaHastaInput.value : '';
                filtrosActivos.soloConsensuados = filtroConsensuadosSidebar ? filtroConsensuadosSidebar.checked : false;

                // Sincronizar el switch principal
                document.getElementById('filtroConsensuados').checked = filtrosActivos.soloConsensuados;

                // Verificar si hay al menos un filtro activo
                const hayFiltrosActivos =
                    filtrosActivos.categoria !== "0" ||
                    filtrosActivos.fuente !== "0" ||
                    filtrosActivos.coleccion !== "0" ||
                    filtrosActivos.fechaDesde ||
                    filtrosActivos.fechaHasta ||
                    filtrosActivos.soloConsensuados;

                if (!hayFiltrosActivos) {
                    alert('Por favor, seleccione al menos un filtro para aplicar');
                    return;
                }

                resultadosBody.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Aplicando filtros...</p>
                    </div>
                `;

                offcanvasResultados.show();

                try {
                    const url = construirUrlFiltrosCompletos();
                    console.log('Fetching URL con filtros avanzados:', url);

                    const resp = await fetch(url);

                    if (!resp.ok) {
                        const errorData = await resp.json().catch(() => ({}));
                        throw new Error(errorData.mensaje || `Error ${resp.status}: ${resp.statusText}`);
                    }

                    const data = await resp.json();
                    const hechosResultantes = data.resultados || [];

                    mostrarResultadosBusqueda(hechosResultantes, filtrosActivos.titulo, filtrosActivos.soloConsensuados);
                    mostrarHechosEnMapa(hechosResultantes);
                    actualizarFiltrosTexto();

                    // Cerrar el sidebar de filtros
                    const offcanvasFiltros = bootstrap.Offcanvas.getInstance('#offcanvasFiltros');
                    if (offcanvasFiltros) {
                        offcanvasFiltros.hide();
                    }

                } catch (error) {
                    console.error('Error en filtros avanzados:', error);
                    resultadosBody.innerHTML = `
                        <div class="alert alert-danger m-3" role="alert">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            <strong>Error al aplicar filtros:</strong><br>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }

            function centrarMapaEnHecho(lat, lng, titulo) {
                if (map) {
                    map.setView([lat, lng], 15);

                    // Abrir el popup del marcador si existe
                    markers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (Math.abs(markerLatLng.lat - lat) < 0.0001 &&
                            Math.abs(markerLatLng.lng - lng) < 0.0001) {
                            marker.openPopup();
                        }
                    });
                }

                const offcanvasResultados = bootstrap.Offcanvas.getInstance('#offcanvasResultados');
                if (offcanvasResultados) {
                    offcanvasResultados.hide();
                }
            }

            // Inicialización
            initMap();

            const hechosData = {{{hechosJson}}};
            mostrarHechosEnMapa(hechosData);
            updateContador(hechosData.length);

            // Event listeners
            document.getElementById('btnBuscarRapido').addEventListener('click', buscarHechos);
            document.getElementById('btnLimpiarBusqueda').addEventListener('click', limpiarBusqueda);

            document.getElementById('searchInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    buscarHechos();
                }
            });

            document.getElementById('filtroConsensuados').addEventListener('change', function() {
                buscarHechos();
            });

            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('ver-en-mapa')) {
                    const button = e.target;
                    const latitud = parseFloat(button.getAttribute('data-latitud'));
                    const longitud = parseFloat(button.getAttribute('data-longitud'));
                    const titulo = button.getAttribute('data-titulo');

                    if (!isNaN(latitud) && !isNaN(longitud)) {
                        centrarMapaEnHecho(latitud, longitud, titulo);
                    }
                }
            });

            // Funciones globales para el sidebar
            window.aplicarFiltros = aplicarFiltrosAvanzados;
            window.limpiarFiltros = limpiarBusqueda;
        });
    </script>

{{/partial}}
{{> templates/layout}}